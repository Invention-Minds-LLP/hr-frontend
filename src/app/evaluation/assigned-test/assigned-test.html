<div class="question-bank">
  <div class="header">
    <!-- <h2>All Tests</h2> -->
    <!-- <button (click)="openForm()" class="add-btn">Add New Test
      <svg xmlns="http://www.w3.org/2000/svg" width="21" height="20" viewBox="0 0 21 20" fill="none">
        <path d="M10.5003 4.16663V15.8333M4.66699 9.99996H16.3337" stroke="white" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </button> -->
    <div class="flex1">
      <div class="filter" (click)="toggleFilterDropdown(); $event.stopPropagation()">
        <i class="pi pi-filter"></i>
        <ul class="menu-list" *ngIf="showFilterDropdown">
          <li class="list" *ngFor="let option of filterOptions" (click)="selectFilter(option); $event.stopPropagation()"
            [ngClass]="{ 'active': selectedFilter?.value === option.value }">
            {{ option.label }}
          </li>
        </ul>
      </div>

      <p-iconfield>
        <p-inputicon class="pi pi-search" />
        <input id="assignedSearch" type="text" pInputText placeholder="Search" (input)="onSearch($event)" />
      </p-iconfield>
    </div>

  </div>

  <p-table [value]="loading ? [1,2,3,4,5] : filteredAssignedtest" [paginator]="!loading" [rows]="10"
    responsiveLayout="scroll">

    <ng-template pTemplate="header">
      <tr>
        <th>No</th>
        <th>Employee</th>
        <th>Test</th>
        <th>Attempts</th>
        <th>Assigned At</th>
        <th>Started At</th>
        <th>Completed At</th>
        <th>Latest Score</th>
        <th>Result</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-a let-i="rowIndex">

      <tr *ngIf="!loading; else skeletonRow">
        <td>{{ i + 1 }}</td>
        <td>{{ a.employee?.firstName }} {{ a.employee?.lastName }}</td>
        <td>{{ a.test?.name }}</td>
        <td>{{ a.attempts }}</td>
        <td>{{ a.assignedAt | date: 'short' }}</td>
        <td>{{ (a.startedAt | date:'short') || '-' }}</td>
        <td>{{ (a.completedAt | date:'short') || '-' }}</td>
        <td>{{ a.latestScore !== null ? a.latestScore : '-' }}</td>
        <td>{{ a.result || '-' }}</td>
        <td>{{ a.status }}</td>
        <td>
          <button label="Overview" class="btn-edit" (click)="openOverview(a)">Overview</button>
        </td>
      </tr>

      <!-- Skeleton Row -->
      <ng-template #skeletonRow>
        <tr>
          <td><p-skeleton width="2rem"></p-skeleton></td>
          <td>
            <div class="flex align-items-center gap-2">
              <!-- <p-skeleton shape="circle" size="2rem"></p-skeleton> -->
              <p-skeleton width="80px" height="12px"></p-skeleton>
            </div>
          </td>
          <td><p-skeleton width="100px"></p-skeleton></td>
          <td><p-skeleton width="40px"></p-skeleton></td>
          <td><p-skeleton width="80px"></p-skeleton></td>
          <td><p-skeleton width="80px"></p-skeleton></td>
          <td><p-skeleton width="80px"></p-skeleton></td>
          <td><p-skeleton width="50px"></p-skeleton></td>
          <td><p-skeleton width="60px"></p-skeleton></td>
          <td><p-skeleton width="50px"></p-skeleton></td>
          <td><p-skeleton width="100px"></p-skeleton></td>
        </tr>
      </ng-template>

    </ng-template>

  </p-table>

</div>

<p-dialog [header]="overview ? (overview.employeeName + ' â€” ' + overview.testName) : 'Test Overview'"
  [(visible)]="overviewVisible" [modal]="true" [style]="{ width: '900px' }" [dismissableMask]="true">
  <ng-container *ngIf="overview as o">
    <div class="ovr-head">
      <div>
        <div class="ovr-title">{{ o.employeeName }} â€¢ {{ o.testName }}</div>
        <div class="ovr-sub">
          Attempt #{{ o.attemptId }} Â·
          Started: {{ o.startedAt | date:'short' }} Â·
          Completed: {{ (o.completedAt | date:'short') || '-' }} Â·
          Time: {{ fmtDuration(o.timeTakenSec) }}
        </div>
      </div>
      <div class="ovr-badges">
        <p-badge severity="success" [value]="'Correct: ' + o.totals.correct"></p-badge>
        <p-badge severity="danger" [value]="'Wrong: ' + o.totals.wrong"></p-badge>
        <p-badge severity="warn" [value]="'Unanswered: ' + o.totals.unanswered"></p-badge>
        <p-badge severity="info" [value]="'Total: ' + o.totals.total"></p-badge>
      </div>
    </div>

    <div class="details">
      <p-table [value]="o.rows" [rows]="10" [paginator]="true" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Question</th>
            <th>Your Answer</th>
            <th>Correct Answer</th>
            <th>Result</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-r>
          <tr>
            <td>{{ r.no }}</td>
            <td>{{ r.text }}</td>
            <td>
              <ng-container *ngIf="r.type === 'MCQ'; else descAns">
                <div *ngIf="r.selectedOptionTexts.length; else dash">
                  <div *ngFor="let t of r.selectedOptionTexts">{{ t }}</div>
                </div>
                <ng-template #dash> - </ng-template>
              </ng-container>

              <ng-template #descAns>
                <div *ngIf="r.rawAnswer">{{ r.rawAnswer }}</div>
                <div *ngIf="r.fileUrl">
                  <a [href]="r.fileUrl" target="_blank">ðŸ“Ž Open Answer</a>
                </div>
                <div *ngIf="!r.rawAnswer && !r.fileUrl"> - </div>
              </ng-template>
            </td>

            <td>
              <div *ngIf="r.correctOptionTexts.length; else na">
                <div *ngFor="let t of r.correctOptionTexts">{{ t }}</div>
              </div>
              <ng-template #na> - </ng-template>
            </td>
            <!-- <td>
              <span *ngIf="r.isCorrect === true" class="ok">Correct</span>
              <span *ngIf="r.isCorrect === false" class="bad">Wrong</span>
              <span *ngIf="r.isCorrect === null" class="na">N/A</span>
            </td> -->
            <td>
              <ng-container *ngIf="r.isCorrect === null; else autoEval">
                <div *ngIf="!r.isEditing; else editMode">
                  <span *ngIf="r.manualScore !== null">Score: {{ r.manualScore }}</span>
                  <small *ngIf="r.remarks"><br />Remarks: {{ r.remarks }}</small>
                  <button pButton type="button" style="width: 60px;" label="Edit" (click)="r.isEditing = true"></button>
                </div>
                <ng-template #editMode>
                  <div class="flex flex-column gap-2">
                    <div class="flex align-items-center gap-2">
                      <p-floatlabel variant="on" style="width: 100px;" class="custom-float">
                        <input pInputText id="on_label" style="width: 100%;" inputmode="numeric"
                          [(ngModel)]="r.manualScore" maxlength="3" autocomplete="off" />
                        <label for="on_label">Score</label>
                      </p-floatlabel>
                      <!-- <input type="number" [(ngModel)]="r.manualScore"
                         min="0" [max]="r.weight || 100"
                         style="width:70px ; padding: 3px; border-radius: 3px;" placeholder="Score" /> -->
                      <span>/ {{ r.weight }}</span>
                    </div>
                    <p-floatlabel variant="on" class="custom-float">
                      <input pInputText id="on_label" [(ngModel)]="r.remarks" autocomplete="off" />
                      <label for="on_label">Remarks</label>
                    </p-floatlabel>
                    <button pButton type="button" style="width: 60px;" label="Save"
                      (click)="r.isEditing = false"></button>
                  </div>
                  <!-- <input type="text" [(ngModel)]="r.remarks" style="width:150px; padding: 3px; border-radius: 3px;"
                    placeholder="Remarks" /> -->


                </ng-template>
              </ng-container>
              <ng-template #autoEval>
                <span *ngIf="r.isCorrect === true" class="ok">Correct</span>
                <span *ngIf="r.isCorrect === false" class="bad">Wrong</span>
              </ng-template>
            </td>




          </tr>

        </ng-template>

      </p-table>
      <div class="mt-3" style="text-align:right" *ngIf="hasDescriptive(o)">
        <button pButton label="Save Evaluation" class="p-button-success" (click)="saveEvaluation(o)">
        </button>
      </div>

    </div>
  </ng-container>
</p-dialog>