<div class="resignation">
  <div class="header">
    <!-- <h2>Resignations</h2> -->
    <div class="flex1">
      <div class="filter" (click)="toggleFilterDropdown()">
        <i class="pi pi-filter"></i>
        <ul class="menu-list" *ngIf="showFilterDropdown">
          <li class="list" *ngFor="let option of filterOptions" (click)="selectFilter(option); $event.stopPropagation()"
            [ngClass]="{ 'active': selectedFilter?.value === option.value }">
            {{ option.label }}
          </li>
        </ul>
      </div>

      <p-iconfield>
        <p-inputicon class="pi pi-search" />
        <input type="text" pInputText placeholder="Search" (input)="onSearch($event)" />
      </p-iconfield>
    </div>
  </div>
  <!-- <button [routerLink]="'/resignation-from'">new form</button> -->
  <p-table [value]="filteredRows" [paginator]="true" [rows]="10" responsiveLayout="scroll">
    <ng-template pTemplate="header">
      <tr>
        <th>No</th>
        <th>Employee</th>
        <th>Department</th>
        <th>Reason</th>
        <th>Manager</th>
        <th>HR</th>
        <th>Proposed LWD</th>
        <th>Actual LWD</th>
        <th>Status</th>
        <th style="text-align:center">Actions</th>
        <th *ngIf="isHR">Proceeding</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-r let-i="rowIndex">
      <ng-template #dash><span class="muted" style="text-align: center;">—</span></ng-template>
      <tr>
        <td>{{ i + 1 }}</td>
        <td>{{ r.employee?.firstName }} {{ r.employee?.lastName }}</td>
        <td>
          <span class="dept-badge"
            [ngStyle]="{ backgroundColor: getDepartmentColors(r.employee?.departmentId).badgeColor }">
            <span class="dot" [ngStyle]="{ backgroundColor: getDepartmentColors(r.employee?.departmentId).dotColor }">
            </span>
            {{ departmentMap[r.employee?.departmentId] }}
          </span>
        </td>
        <td>
          <span class="reason" pTooltip="{{ r.reason }}" tooltipPosition="top">
            {{ r.reason?.length > 6 ? (r.reason | slice:0:6) + '…' : r.reason }}
          </span>
        </td>
        <td>{{ r.managerDecision }}</td>
        <td>{{ r.hrDecision }}</td>
        <td>{{ r.proposedLastWorkingDay | date:'mediumDate' }}</td>
        <td>{{ r.actualLastWorkingDay ? (r.actualLastWorkingDay | date:'mediumDate') : '-' }}</td>
        <td><span class="chip s-{{ r.status }}">{{ r.status }}</span></td>
        <td class="actions">
          <ng-container *ngIf="
      (r.managerDecision === 'PENDING' && ( employeeId === r?.employee?.reportingManager)) ||
      (r.managerDecision === 'APPROVED' && r.hrDecision === 'PENDING' && (role === 'HR' || role === 'HR Manager')) ||
      (r.status === 'WITHDRAW_REQUESTED' && isHR);
    else dash">
          <ng-container *ngIf="r.managerDecision === 'PENDING' && (employeeId === r?.employee?.reportingManager)">
            <button pButton size="small" label="Manager Approve" (click)="approveManager(r)"></button>
            <button pButton size="small" label="Manager Reject" class="p-button-danger"
              (click)="rejectManager(r)"></button>
          </ng-container>
          <ng-container
            *ngIf="r.managerDecision=== 'APPROVED' && r.hrDecision === 'PENDING' && (role === 'HR' || role === 'HR Manager')">
            <button pButton size="small" label="HR Approve" class="p-button-success" (click)="openApprovePopup(r)"></button>
            <button pButton size="small" label="HR Reject" class="p-button-danger" (click)="rejectHR(r)"></button>
            <button pButton size="small" label="On Hold" class="p-button-warning"
              style="background-color: rgb(244, 233, 89);" (click)="holdHR(r)"></button>
            <button pButton size="small" label="Cancel" class="p-button-secondary" (click)="cancelHR(r)"></button>
          </ng-container>
          <!-- HR withdraw request actions -->
          <ng-container *ngIf="r.status === 'WITHDRAW_REQUESTED' && isHR">
            <button pButton size="small" label="Approve Withdraw" class="p-button-success"
              (click)="approveWithdrawHR(r)"></button>
            <button pButton size="small" label="Reject Withdraw" class="p-button-danger"
              (click)="rejectWithdrawHR(r)"></button>
          </ng-container>
          </ng-container>
        </td>
        <td *ngIf="isHR" style="text-align:center">
          <button *ngIf="isHR && r?.hrDecision=== 'APPROVED';else dash" class="btn-edit" (click)="openDialog(r.id)">
            Proceed to off-boarding
          </button>
          <p-dialog [visible]="isOpen(r.id)" (visibleChange)="dialogOpen[r.id] = $event" [modal]="true"
            header="Off-boarding" [style]="{ width: '80vw' }">
            <app-resign-post [resignationId]="r?.id"
              [employeeName]="r?.employee?.firstName + ' ' + r?.employee?.lastName">
            </app-resign-post>
          </p-dialog>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="10" class="no-data">No resignations.</td>
      </tr>
    </ng-template>
  </p-table>
</div>
<p-dialog
  header="Approve Resignation"
  [(visible)]="showApprovePopup"
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [style]="{ width: '400px' }"
>
  <div class="p-fluid">
    <div class="p-field">
      <label for="lwd">Actual Last Working Day</label>
      <p-datepicker
        id="lwd"
        [(ngModel)]="selectedLwd"
        dateFormat="yy-mm-dd"
        [showIcon]="true"
        inputId="lwd"
        style="width: 100%;"
        appendTo="body"
        class="mt-2"
      ></p-datepicker>
    </div>

    <!-- Optional context info -->
    <div class="p-field" *ngIf="selectedRecord">
      <p><strong>Employee:</strong> {{ selectedRecord?.employee?.firstName }} {{ selectedRecord?.employee?.lastName }}</p>
      <p><strong>Proposed LWD:</strong> {{ selectedRecord?.proposedLastWorkingDay | date: 'yyyy-MM-dd' }}</p>
    </div>
  </div>

  <!-- ✅ Footer section (modern way) -->
  <ng-template pTemplate="footer">
    <div class="footer-actions" style="text-align: right;">
      <button
        pButton
        label="Cancel"
        icon="pi pi-times"
        class="p-button-text"
        (click)="showApprovePopup = false"
      ></button>
      <button
        pButton
        label="Approve"
        icon="pi pi-check"
        class="p-button-success"
        (click)="submitHRApproval()"
        [disabled]="!selectedLwd"
      ></button>
    </div>
  </ng-template>
</p-dialog>
