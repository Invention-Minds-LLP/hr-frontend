<div class="individual-container" *ngIf="!showSurveyForm">

    <div class="individual-top">
        <div class="part-1">
            <!-- Attendance-card -->

            <!-- <div class="attendance-card">
                <div class="date-header">
                    <button pButton icon="pi pi-angle-left" (click)="goToPreviousDay()" class="arrow-btn"></button>

                    <div class="date-info">
                        <div class="day-number">{{ selectedDate | date: 'dd' }}</div>
                        <div class="day-details">
                            <div class="day-name">{{ selectedDate | date: 'EEEE' }}</div>
                            <div class="month-year">{{ selectedDate | date: 'MMMM yyyy' }}</div>
                        </div>
                    </div>

                    <button pButton icon="pi pi-angle-right" class="arrow-btn" (click)="goToNextDay()"
                        [disabled]="isToday(selectedDate)">
                    </button>
                </div>


                <div class="status-title">This Week Status</div>
                <div class="week-status">
                    <div class="days">
                        <div class="day" *ngFor="let d of weekDays">
                            <div class="day-label">{{ d.day }}</div>
                            <div class="status-icon"
                                [ngClass]="{'present': d.status === 'present','absent': d.status === 'absent','holiday': d.status === 'holiday'}">
                                <ng-container [ngSwitch]="d.status">
                                    <span *ngSwitchCase="'present'">&#10003;</span>
                                    <span *ngSwitchCase="'absent'">A</span>
                                    <span *ngSwitchCase="'holiday'">&#8211;</span>
                                    <span *ngSwitchCase="'none'">&#9711;</span>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button pButton label="Log In" class="login-btn" [disabled]="selectedDate < today"></button>
                    <button pButton label="Log Out" class="logout-btn" [disabled]="selectedDate < today"></button>
                </div>
            </div> -->
            <div class="employee-card">
                <!-- Show skeletons while loading -->
                <ng-container *ngIf="!employee; else employeeLoaded">
                    <!-- Profile Header -->
                    <div class="profile-header">
                        <p-skeleton shape="circle" size="6rem" class="profile-pic mb-3"></p-skeleton>
                        <div class="employee-info mt-3">
                            <p-skeleton width="10rem" class="mb-2"></p-skeleton>
                            <p-skeleton width="6rem" class="mb-2"></p-skeleton>
                            <p-skeleton width="8rem" class="mb-2"></p-skeleton>
                        </div>
                    </div>

                    <!-- Contact Section -->
                    <div class="employee-contact mt-3">
                        <p-skeleton width="12rem" class="mb-2"></p-skeleton>
                        <p-skeleton width="15rem" class="mb-2"></p-skeleton>
                    </div>

                    <!-- Department / Branch / Joining -->
                    <div class="employee-meta mt-3 w-100">
                        <p-skeleton width="18rem" class="mb-2"></p-skeleton>
                        <p-skeleton width="14rem" class="mb-2"></p-skeleton>
                    </div>

                    <!-- Health Info -->
                    <div class="employee-meta mt-3 w-100">
                        <p-skeleton width="10rem" class="mb-2"></p-skeleton>
                        <p-skeleton width="8rem" class="mb-2"></p-skeleton>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="employee-meta mt-3">
                        <p-skeleton width="10rem" class="mb-2"></p-skeleton>
                    </div>
                </ng-container>

                <!-- Show real data when employee is loaded -->
                <ng-template #employeeLoaded>
                    <!-- Profile Header -->
                    <div class="profile-header">
                        <img [src]="employee.photoUrl || getDefaultImage()" (error)="onImageError($event)" alt="Profile"
                            class="profile-pic" />
                        <div class="employee-info mt-3">
                            <div class="employee-name">{{ employee.firstName }} {{ employee.lastName }}</div>
                            <div class="employee-role">{{ employee.designation }}</div>
                            <div class="employee-code">Code: {{ employee.employeeCode }}</div>
                        </div>
                    </div>

                    <!-- Contact Section -->
                    <div class="employee-contact mt-3">
                        <div class="contact-item">
                            <i class="pi pi-phone"></i> {{ employee.phone }}
                        </div>
                        <div class="contact-item">
                            <i class="pi pi-envelope"></i> {{ employee.email }}
                        </div>
                    </div>

                    <!-- Department / Branch / Joining -->
                    <div class="employee-meta mt-3 w-100">
                        <div class="flex2">
                            <strong>Department -</strong>
                            <span class="div">{{ employee.departmentName || '-' }}</span>
                        </div>
                        <div class="flex2">
                            <strong>Date of Joining -</strong>
                            <span class="div">{{ employee.dateOfJoining | date: 'dd MMM yyyy' }}</span>
                        </div>
                    </div>

                    <!-- Health Info -->
                    <div class="employee-meta mt-3 w-100">
                        <div class="flex2"><strong>Blood Group:</strong> {{ employee.bloodGroup || '-' }}</div>
                        <div class="flex2"><strong>Age:</strong> {{ employee.age || '-' }}</div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="employee-meta mt-3" *ngIf="employee.emergencyContacts?.length">
                        <div><strong>Emergency Contact:</strong></div>
                        <div>
                            {{ employee.emergencyContacts[0]?.name }} ({{ employee.emergencyContacts[0]?.relationship
                            }}) -
                            {{ employee.emergencyContacts[0]?.phone }}
                        </div>
                    </div>
                </ng-template>

                <div class="employee-meta flex" *ngIf="pendingSurveys.length > 0 && !showSurveyForm">
                    <!-- <div><strong>Take Survey</strong></div> -->
                  
                    <div *ngFor="let survey of pendingSurveys">
                      <p-button
                        label="Take Survey"
                        icon="pi pi-file-edit"
                        (click)="openSurveyForm(survey)">
                      </p-button>
                    </div>
                  </div>
                  
            </div>

            <!-- Working-Card -->
            <div class="working-hours">
                <ng-container *ngIf="!attendanceData; else workingCard">
                    <div class="title">
                        <p-skeleton width="8rem" height="1.5rem" class="mb-2"></p-skeleton>
                        <p-skeleton width="5rem" height="1rem"></p-skeleton>
                    </div>
                    <div class="flex">
                        <p-skeleton shape="circle" size="2rem" class="mr-2"></p-skeleton>
                        <p-skeleton width="10rem" height="1rem" class="mr-2"></p-skeleton>
                        <p-skeleton shape="circle" size="2rem"></p-skeleton>
                    </div>

                </ng-container>
                <ng-template #workingCard>
                    <div class="working-card">
                        <div class="header">
                            <div class="title">
                                <h3>Working Hours</h3>
                                <div class="">
                                    <span class="shift">{{ shiftName }}</span>
                                </div>
                            </div>
                            <div class="flex">
                                <button pButton icon="pi pi-chevron-left" (click)="previousWeek()"
                                    class="p-button-text"></button>
                                <p>{{ weekStart | date:'dd MMM yyyy' }} - {{ weekEnd | date:'dd MMM yyyy' }}</p>
                                <button pButton icon="pi pi-chevron-right" (click)="nextWeek()" class="p-button-text"
                                    [disabled]="isCurrentWeek()">
                                </button>
                            </div>
                        </div>

                        <div class="attendance-list">
                            <div *ngFor="let day of attendanceData" class="attendance-row">
                                <div class="day">{{ day.dayName }}</div>

                                <ng-container [ngSwitch]="day.status">
                                    <div class="time" *ngSwitchCase="'Present'">
                                        {{ day.totalHours || '0 hrs 0 mins' }}
                                      </div>                                
                                    <div class="status leave" *ngSwitchCase="'Leave'">Leave</div>
                                    <div class="status off" *ngSwitchCase="'Day Off'">Day Off</div>
                                    <div class="status empty" *ngSwitchCase="'Empty'"></div>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </ng-template>
            </div>
        </div>


        <div class="part-2">
            <div class="box-1">
                <div class="holiday-card box">
                    <!-- Skeleton Loader -->
                    <ng-container *ngIf="!holidayDates?.length; else holidayContent">
                        <div class="skeleton-wrapper">
                            <!-- Header Skeleton -->
                            <div class="header flex justify-content-between align-items-center mb-3">
                                <div class="flex align-items-center gap-2">
                                    <p-skeleton width="9rem" height="1.5rem"></p-skeleton>
                                    <p-skeleton shape="circle" size="2rem"></p-skeleton>
                                    <p-skeleton shape="circle" size="2rem"></p-skeleton>
                                </div>
                            </div>

                            <!-- Holiday Info Skeleton -->
                            <div class="holiday-display">
                                <p-skeleton width="8rem" height="1.5rem" class="mb-2"></p-skeleton>
                                <p-skeleton width="10rem" height="1.2rem"></p-skeleton>
                            </div>
                        </div>
                    </ng-container>

                    <!-- Actual Holiday Data -->
                    <ng-template #holidayContent>
                        <div class="next" *ngIf="holidayDates.length > 0; else noHolidays">
                            <span class="arrow prev" [class.disabled]="currentIndex === 0" (click)="prevHoliday()">
                                <i class="pi pi-chevron-left"></i>
                            </span>

                            <h2>Nearest Holiday</h2>

                            <span class="arrow next" [class.disabled]="currentIndex === holidayDates.length - 1"
                                (click)="nextHoliday()">
                                <i class="pi pi-chevron-right"></i>
                            </span>
                        </div>

                        <div class="holiday-display">
                            <div class="holiday-date">{{ nearestHoliday?.date | date: 'dd MMM yyyy' }}</div>
                            <div class="holiday-name">{{ nearestHoliday?.name }}</div>
                        </div>
                    </ng-template>

                    <ng-template #noHolidays>
                        <p>{{ noHolidaysMessage }}</p>
                    </ng-template>
                </div>

            </div>

            <!-- Today Birthday -->

            <!-- <ng-template > -->
            <div class="box box-2">
                <h4 class="box-title">Today Birthday</h4>

                <!-- none -->
                <div class="empty" *ngIf="birthday.length === 0">No birthdays today</div>

                <!-- <= 3: simple list -->
                <div class="list-3" *ngIf="birthday.length > 0 && birthday.length <= 1">
                    <div class="person-chip" *ngFor="let b of birthday; trackBy: trackById">
                        <div class="name">{{ b.employeeName }}</div>
                        <div class="dept">{{ b.departmentName || '-' }}</div>
                    </div>
                </div>

                <!-- > 3: carousel -->
                <p-carousel *ngIf="birthday.length > 1" [value]="birthday" [numVisible]="1" [numScroll]="1"
                    [circular]="true" [showIndicators]="true">
                    <ng-template pTemplate="item" let-item>
                        <div class="person-chip">
                            <div class="name">{{ item.employeeName }}</div>
                            <div class="dept">{{ item.departmentName || '-' }}</div>
                        </div>
                    </ng-template>
                </p-carousel>
            </div>
            <!-- </ng-template> -->

            <!-- Today Work Anniversary -->
            <div class="box box-3">
                <h4 class="box-title">Today Work Anniversary</h4>

                <!-- none -->
                <div class="empty" *ngIf="anniversary.length === 0">No work anniversaries today</div>

                <!-- <= 3 -->
                <div class="list-3" *ngIf="anniversary.length > 0 && anniversary.length <= 1">
                    <div class="person-chip" *ngFor="let a of anniversary">
                        <div class="name">{{ a.employeeName }}</div>
                        <div class="dept">
                            {{ a.departmentName || '-' }}
                            <!-- <span *ngIf="a.years !== undefined"> · {{ a.years }} yr{{ a.years > 1 ? 's' : '' }}</span> -->
                        </div>
                    </div>

                </div>

                <!-- > 3 -->
                <p-carousel *ngIf="anniversary.length > 1" [value]="anniversary" [numVisible]="1" [numScroll]="1"
                    [circular]="true" [showIndicators]="true">
                    <ng-template pTemplate="item" let-item>
                        <div class="person-chip">
                            <div class="name">{{ item.employeeName }}</div>
                            <div class="dept">
                                {{ item.departmentName || '-' }}
                                <span *ngIf="item.years !== undefined"> · {{ item.years }} yr{{ item.years > 1 ? 's' :
                                    '' }}</span>
                            </div>
                        </div>
                    </ng-template>
                </p-carousel>
            </div>

            <div class="box box-4">
                <div class="box-title">Pending Leaves</div>

                <ul class="lb-list">
                    <li class="lb-item" *ngFor="let it of leaveByTypeToday">
                        <span class="lb-name">{{ it.label }}</span>
                        <span class="lb-badge">{{ it.count }}</span>
                    </li>
                </ul>
            </div>



        </div>
    </div>



    <div class="individual-bottom">
        <!-- Leave -->
        <div class="leave-table">
            <div>
                <div class="header-part">
                    <div class="main-heading">Leaves
                        <i class="pi pi-info-circle info-icon"
                            pTooltip="Apply leave for personal or medical reasons. Select dates, type of leave, and submit for approval."
                            tooltipPosition="top"></i>
                    </div>
                    <div class="new-form" (click)="openLeaveForm()">
                        <div class="text">New Form</div>
                        <div><i class="pi pi-plus"></i></div>
                    </div>
                </div>
                <ng-container *ngIf="loading; else leaveTable">
                    <p-table [value]="[1, 2, 3, 4, 5]" [scrollable]="true" scrollHeight="600px">
                        <!-- Header -->
                        <ng-template pTemplate="header">
                            <tr>
                                <th *ngFor="let h of ['No','Date','Status','Actions']">
                                    {{ h }}
                                </th>
                            </tr>
                        </ng-template>

                        <!-- Body -->
                        <ng-template pTemplate="body">
                            <tr>
                                <td><p-skeleton width="2rem" height="1.2rem"></p-skeleton></td>

                                <td><p-skeleton width="70px" height="1.5rem"></p-skeleton></td>
                                <td><p-skeleton width="90px" height="1.5rem"></p-skeleton></td>
                                <td><p-skeleton width="100px" height="1.5rem"></p-skeleton></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </ng-container>
                <ng-template #leaveTable>
                    <div class="table">
                        <p-table [value]="leave" [scrollable]="true" scrollHeight="300px" scrollDirection="vertical">
                            <ng-template #header>
                                <tr>
                                    <th>NO</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </ng-template>
                            <ng-template #body let-leave let-rowIndex="rowIndex">
                                <tr>
                                    <td>{{rowIndex + 1}}</td>
                                    <td>
                                        <div class="dropdown-container-in-table"
                                            *ngIf="leave.dates?.length > 0; else noLeaveDates">
                                            <select class="dropdown-in-table">
                                                <option disabled>
                                                    {{ leave.dates[0] }} — {{ leave.dates[leave.dates.length - 1] }}
                                                </option>
                                                <option *ngFor="let d of leave.dates" [value]="d">
                                                    {{ d }}
                                                </option>
                                            </select>
                                        </div>
                                        <ng-template #noLeaveDates>
                                            <span>-</span>
                                        </ng-template>
                                    </td>


                                    <td><span class="status style" [ngClass]="getStatusClass(leave.status)">{{
                                            leave.status }}</span></td>
                                    <td><span class="btn style" (click)="viewLeaveDetails(leave)">See details</span>
                                    </td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="3" class="no-data-message">
                                        <i class="pi pi-info-circle"></i>
                                        No leave requests found.
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </ng-template>
            </div>


        </div>

        <div class="border"></div>
        <!--permission  -->
        <div class="permission-table">
            <div>
                <div class="header-part">
                    <div class="main-heading">Permission
                        <i class="pi pi-info-circle info-icon"
                            pTooltip="Request short-term permissions (like arriving late or leaving early). Not for full-day leave."
                            tooltipPosition="top">
                        </i>
                    </div>
                    <div class="new-form" (click)="openPermissionForm()">
                        <div class="text">New Form</div>
                        <div><i class="pi pi-plus"></i></div>
                    </div>
                </div>
                <ng-container *ngIf="loading; else permissionTable">
                    <p-table [value]="[1, 2, 3, 4, 5]" [scrollable]="true" scrollHeight="600px">
                        <!-- Header -->
                        <ng-template pTemplate="header">
                            <tr>
                                <th *ngFor="let h of ['No','Date','Status','Actions']">
                                    {{ h }}
                                </th>
                            </tr>
                        </ng-template>

                        <!-- Body -->
                        <ng-template pTemplate="body">
                            <tr>
                                <td><p-skeleton width="2rem" height="1.2rem"></p-skeleton></td>

                                <td><p-skeleton width="70px" height="1.5rem"></p-skeleton></td>
                                <td><p-skeleton width="90px" height="1.5rem"></p-skeleton></td>
                                <td><p-skeleton width="100px" height="1.5rem"></p-skeleton></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </ng-container>
                <ng-template #permissionTable>
                    <div class="table">
                        <p-table [value]="permission" [scrollable]="true" scrollHeight="300px"
                            scrollDirection="vertical">
                            <ng-template #header>
                                <tr>
                                    <th>No</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </ng-template>
                            <ng-template #body let-permission let-rowIndex="rowIndex">
                                <tr>
                                    <td>{{rowIndex + 1}}</td>
                                    <td>
                                        <div class="date date-btn style">
                                            <span class="">{{ permission.date }}</span>
                                            <!-- <i class="pi pi-chevron-down"></i> -->
                                        </div>
                                    </td>
                                    <td><span class="status style" [ngClass]="getStatusClass(permission.status)">{{
                                            permission.status }}</span></td>
                                    <td><span class="btn style" (click)="viewPermissionDetails(permission)">See
                                            details</span></td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="3" class="no-data-message">
                                        <i class="pi pi-info-circle"></i>
                                        No Permission requests found.
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </ng-template>
            </div>
            <!-- <div class="border"></div> -->
        </div>

        <!-- Work From Home -->
        <!-- <div class="wfh">
            <div style="width: 100%;">
                <div class="header-part">
                    <div class="main-heading">WFH</div>
                    <div class="new-form " (click)="openWFHForm()">
                        <div class="text ">New Form</div>
                        <div><i class="pi pi-plus"></i></div>
                    </div>
                </div>

                <div class="table">
                    <p-table [value]="wfh" [scrollable]="true" scrollHeight="300px" scrollDirection="vertical">
                        <ng-template #header>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </ng-template>
                        <ng-template #body let-wfh>
                            <tr>
                                <td>
                                    <div class="dropdown-container-in-table"
                                        *ngIf="wfh.dates?.length > 0; else noWfhDates">
                                        <select class="dropdown-in-table">
                                            <option disabled>
                                                {{ wfh.dates[0] }} — {{ wfh.dates[wfh.dates.length - 1] }}
                                            </option>
                                            <option *ngFor="let d of wfh.dates" [value]="d">{{ d }}</option>
                                        </select>
                                    </div>
                                    <ng-template #noWfhDates>
                                        <span>-</span>
                                    </ng-template>
                                </td>


                                <td><span class="status style" [ngClass]="getStatusClass(wfh.status)">{{
                                        wfh.status }}</span></td>
                                <td><span class="btn style" (click)="viewWFHDetails(wfh)">See details</span></td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="3" class="no-data-message">
                                    <i class="pi pi-info-circle"></i>
                                    No WFH requests found.
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </div> -->
    </div>

    <!-- <div class="">
        <app-resignation-form></app-resignation-form>
    </div> -->

    <div class="test-list">
        <h1>Training Management
            <i class="pi pi-info-circle info-icon"
                pTooltip="Create, assign, and track employee trainings to enhance skills and performance.."
                tooltipPosition="top"></i>
        </h1>
        <app-training-list [viewMode]="'individual'"></app-training-list>
    </div>

    <div class="my-test">
        <app-my-tests></app-my-tests>
    </div>




    <div class="bottom">
        <div class="grievance">
            <app-grievance-list></app-grievance-list>
        </div>

        <div class="posh">
            <app-posh-list></app-posh-list>
        </div>
    </div>


    <!-- <div class="">
        <div class="survey">
            <h1>Survey</h1>
            <app-survey-list></app-survey-list>
        </div>

        <div class="exit">
            <h1>Exit Interview</h1>
            <app-exit-interview-list></app-exit-interview-list>
        </div>
    </div> -->


</div>

<app-leave-popup *ngIf="showLeaveDetailsPopup" [showPopup]="true" [leaveData]="selectedLeaveForView"
    [isViewOnly]="leaveViewMode" [hasBackdrop]="true" (close)="closePopup()">
</app-leave-popup>


<app-permission-popup *ngIf="showPermissionPopup" [showPopup]="true" [permissionData]="selectedPermission"
    [isViewOnly]="permissionViewMode" (close)="closePopup()">
</app-permission-popup>

<!-- <app-wfh-popup *ngIf="showWFHPopup" [showPopup]="true" [wfhData]="selectedWFH" [isViewOnly]="wfhViewMode"
    [hasBackDrop]="true" (close)="closePopup()">
</app-wfh-popup> -->

<app-survey-form
  *ngIf="showSurveyForm"
  [surveyData]="selectedSurvey"
  (closeForm)="onSurveyFormClose()">
</app-survey-form>
