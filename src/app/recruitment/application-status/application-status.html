<div class="card">
  <div class="flex justify-content-between align-items-center">
    <h2>Application Status</h2>

    <div class="filters">
      <!-- <label>
        <span>Job</span>
        <select [(ngModel)]="selectedJobId" (change)="load()">
          <option [ngValue]="undefined">All jobs</option>
          <option *ngFor="let j of jobs" [ngValue]="j.id">{{ j.title }}</option>
        </select>
      </label>
  
      <label>
        <span>Status</span>
        <select [(ngModel)]="filterStatus" (change)="load()">
          <option [ngValue]="''">Any</option>
          <option
            *ngFor="let s of ['APPLIED','SCREENING','SHORTLISTED','INTERVIEW_SCHEDULED','INTERVIEWED','OFFERED','OFFER_ACCEPTED','OFFER_DECLINED','REJECTED','WITHDRAWN','HIRED','NO_SHOW']"
            [ngValue]="s">
            {{ s }}
          </option>
        </select>
      </label>
  
      <label class="grow">
        <span>Search</span>
         <i class="pi pi-search" style="margin-right: .5rem;"></i>
        <input [(ngModel)]="q" (keyup.enter)="load()" placeholder="Search Candidate or Email" />
      </label>
  
      <button (click)="load()">Load</button> -->

   <!-- Job Select -->
   <!-- <div class="select-box">
    <select [(ngModel)]="selectedJobId" (change)="load()" required>
      <option [ngValue]="null" disabled hidden>Select Job</option>
      <option *ngFor="let j of jobs" [ngValue]="j.id">{{ j.title }}</option>
    </select>
  </div>
  
  <div class="select-box">
    <select [(ngModel)]="filterStatus" (change)="load()" required>
      <option [ngValue]="null" disabled hidden>Status</option>
      <option
        *ngFor="let s of statuses"
        [ngValue]="s">
        {{ s }}
      </option>
    </select>
  </div>
  


        <div class="search-box">
          <i class="pi pi-search search-icon"></i>
          <input
            [(ngModel)]="q"
            (keyup.enter)="load()"
            placeholder="Search Employee"
          />
        </div>
      
        <button class="load-btn" (click)="load()">Load</button> -->
      
    </div>
  </div>

  <ng-container *ngIf="loading; else status">
    <table  scrollHeight="600px">
      <!-- Header -->
      <thead>
        <tr>
          <th *ngFor="let h of ['No','Candidate','Job Title','Offer','Resume','Status','Actions','Overview']">
            {{ h }}
          </th>
        </tr>
      </thead>

      <!-- Body -->
      <tbody>
        <tr>
          <td><p-skeleton width="2rem" height="1.2rem"></p-skeleton></td>

          <!-- <td>
                            <div class="profile-skeleton">
                                <p-skeleton shape="circle" size="3rem" styleClass="profile-avatar"></p-skeleton>
                                <div class="profile-text">
                                    <p-skeleton width="90px" height="12px" styleClass="mb-1"></p-skeleton>
                                    <p-skeleton width="60px" height="10px"></p-skeleton>
                                </div>
                            </div>
                        </td> -->

          <td><p-skeleton width="70px" height="1.5rem"></p-skeleton></td>
          <td><p-skeleton width="90px" height="1.5rem"></p-skeleton></td>
          <td><p-skeleton width="100px" height="1.5rem"></p-skeleton></td>
          <td><p-skeleton width="60px" height="1.5rem"></p-skeleton></td>
          <td><p-skeleton width="80px" height="1.5rem"></p-skeleton></td>
          <td><p-skeleton width="100px" height="1.5rem"></p-skeleton></td>
          <td><p-skeleton width="60px" height="1.5rem"></p-skeleton></td>
          <!-- <td><p-skeleton width="80px" height="1.5rem"></p-skeleton></td> -->
        </tr>
      </tbody>
    </table>
  </ng-container>

  <ng-template #status>
    <div class="table-wrap" *ngIf="apps.length > 0; else empty">
      <table class="custom-table">
        <colgroup>
          <col style="width:5%">
          <col style="width:25%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:9%">
          <col style="width:15%">
          <col style="width:15%">
          <col style="width:20%">
        </colgroup>
  
        <thead>
          <tr>
            <th>No</th>
            <th>Candidate</th>
            <th>Job Title</th>
            <!-- <th>Stage</th> -->
            <th>Offer</th>
            <th style="text-align: left">Resume</th>
            <th>Status</th>
            <th class="center">Actions</th>
            <th class="center">Overview</th>
          </tr>
        </thead>
  
        <tbody>
          <tr *ngFor="let a of apps; let i = index">
            <td>{{i + 1}}</td>
            <td>
              <div class="name">{{ a.candidate?.name }}</div>
              <div class="email" [title]="a.candidate?.email">{{ a.candidate?.email }}</div>
            </td>
            <!-- <td [title]="a.job?.title">{{ a.job?.title }}</td> -->
            <td class="title">
              <span class="text"
                    pTooltip="{{ a.job?.title }}"
                    tooltipPosition="top">
                {{ truncate(a.job?.title, 10) }}
              </span>
            </td>
            
            
            
            <!-- <td>{{ a.status || '—' }}</td> -->
            <td>{{ a.offer?.status || '—' }}</td>
            <td class="resume">
              <ng-container *ngIf="resumeUrl(a); else noResume">
                <a [href]="resumeUrl(a)!" target="_blank" rel="noopener"
                   pTooltip="View Resume" tooltipPosition="top">
                  <i class="pi pi-external-link"></i>
                </a>
              </ng-container>
            
              <ng-template #noResume>
                <span class="muted">—</span>
              </ng-template>
            </td>
            
            <td><span class="pill" [ngStyle]="{
            backgroundColor: getApplicationStatusColors(a.status).badgeColor,
            color: getApplicationStatusColors(a.status).dotColor}">{{ a.status }}</span></td>
  
  
            <td class="actions">
              <p-select [options]="actionOptionsFor(a)" [(ngModel)]="actionSel[a.id]" placeholder="Choose action"
                appendTo="body" [style]="{ width: '10rem' }"
                (onChange)="onActionChange(a, $event.value)">
              </p-select>
            </td>
            <td>
              <button pButton label="Overview" icon="pi pi-eye" class="p-button-text" (click)="openSummaryDialog(a)">
              </button>
            </td>
  
          </tr>
        </tbody>
  
  
      </table>
    </div>
  </ng-template>
  <ng-template #empty>
    <p>No applications found.</p>
  </ng-template>

</div>
<!-- ... your existing table / page content ... -->

<!-- ====================== -->
<!-- Schedule Interview     -->
<!-- ====================== -->
<p-dialog header="Schedule Interview" [(visible)]="showInterviewDialog" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'48vw', '640px':'92vw' }" [style]="{ width:'640px' }"
  (onHide)="onInterviewDialogHide()" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Schedule Interview</span>

      <button class="dialog-close-btn" (click)="showInterviewDialog = false">
        ✕
      </button>
    </div>
  </ng-template>
  <form [formGroup]="interviewForm" class="si-body p-fluid">
    <!-- Stage -->
    <div class="si-field">
      <label class="si-label">Stage <span class="si-req">*</span></label>
      <p-select formControlName="stage" [options]="[
        { label:'Panel', value:'Panel'},
        { label:'Management', value:'Management'}
      ]" placeholder="Choose stage">
      </p-select>

    </div>

    <!-- Time row -->
    <div class="dialog-row">
      <!-- Start -->
      <div class="dialog-field">
        <label class="si-label">Start <span class="si-req">*</span></label>
        <div class="si-input si-grid-2">
          <p-datepicker formControlName="startDate" [showTime]="false" appendTo="body"></p-datepicker>
          <p-datepicker formControlName="startTime" [showTime]="true" [timeOnly]="true" hourFormat="24"
            appendTo="body"></p-datepicker>
        </div>
      </div>

      <!-- End -->
      <div class="dialog-field">
        <label class="si-label">End <span class="si-req">*</span></label>
        <div class="si-input si-grid-2">
          <p-datepicker formControlName="endDate" [showTime]="false" appendTo="body"></p-datepicker>
          <p-datepicker formControlName="endTime" [showTime]="true" [timeOnly]="true" hourFormat="24"
            appendTo="body"></p-datepicker>
        </div>
      </div>

    </div>


    <p-divider class="si-divider"></p-divider>

    <!-- Panel multi-select -->
    <div class="si-field">
      <label class="si-label">Panel interviewers</label>
      <p-multiSelect [options]="panelOptions" formControlName="panelIds" defaultLabel="Select interviewers"
        [filter]="true" [showClear]="true" [display]="'chip'" appendTo="body"> <ng-template pTemplate="item" let-opt>
          <div class="option-row"> <i class="pi pi-user" style="margin-right:.5rem;"></i>
            <div>
              <div class="name">{{ opt.label }}</div> <small class="muted">ID: {{ opt.value }} · {{ opt.meta?.code
                }}</small>
            </div>
          </div>
        </ng-template> <ng-template pTemplate="selectedItems" let-values> <ng-container *ngIf="values?.length; else ph">
            <p-chip *ngFor="let v of values" [label]="panelLabelById(v)"></p-chip> </ng-container> <ng-template #ph>
            Select interviewers </ng-template> </ng-template> </p-multiSelect>

    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" class="p-button-text" (click)="showInterviewDialog=false"></button>
    <button pButton type="button" label="Save" [loading]="isLoading" [label]="isLoading ? 'Saving': 'Save'" icon="pi pi-check" (click)="submitInterview()"
      [disabled]="interviewForm.invalid"></button>
  </ng-template>
</p-dialog>



<!-- ====================== -->
<!-- Send Offer (optional date) -->
<!-- ====================== -->
<p-dialog header="Send Offer" [(visible)]="showOfferDialog" [modal]="true" [dismissableMask]="true" [draggable]="false"
  [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }" [style]="{ width:'420px' }"
  (onHide)="offerForm.reset(); currentApp && resetAction(currentApp.id)" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Send Offer</span>

      <button class="dialog-close-btn" (click)="showOfferDialog = false">
        ✕
      </button>
    </div>
  </ng-template>
  <form [formGroup]="offerForm" class="dialog-body p-fluid">
    <div class="dialog-field">
      <label class="label">Proposed Join <span class="muted">(optional)</span></label>
      <p-datepicker formControlName="proposedJoinAt" [showTime]="true" hourFormat="24" appendTo="body"></p-datepicker>
      <small class="hint">You can leave this blank and set it later.</small>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <!-- <button pButton type="button" label="Skip" class="p-button-text"  [loading]="isLoading" [label]="isLoading ? 'Skipping': 'Skip'" (click)="submitOffer(true)"></button> -->
    <button pButton type="button" label="Send" icon="pi pi-send"  [loading]="isLoading" [label]="isLoading ? 'Sending': 'Send'" (click)="submitOffer(false)"></button>
  </ng-template>
</p-dialog>


<!-- ====================== -->
<!-- Reason (Decline / No-show) -->
<!-- ====================== -->
<p-dialog [header]="reasonDialogTitle" [(visible)]="showReasonDialog" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }" [style]="{ width:'480px' }"
  (onHide)="reasonForm.reset(); currentApp && resetAction(currentApp.id)" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>{{reasonDialogTitle}}</span>

      <button class="dialog-close-btn" (click)="showReasonDialog = false">
        ✕
      </button>
    </div>
  </ng-template>
  <form [formGroup]="reasonForm" class="dialog-body p-fluid">
    <div class="field">
      <label class="label">{{ reasonDialogLabel }}</label>
      <textarea pInputTextarea rows="4" autoResize="true" formControlName="reason"
        placeholder="Add a brief reason"></textarea>
      <small class="hint">
        Be concise; this will be visible in the application timeline.
        <span class="muted" *ngIf="reasonForm.get('reason')?.value?.length">
          ({{ reasonForm.get('reason')?.value?.length }} chars)
        </span>
      </small>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" class="p-button-text" (click)="showReasonDialog=false"></button>
    <button pButton type="button" label="Save" icon="pi pi-check"  [loading]="isLoading" [label]="isLoading ? 'Saving': 'Save'" (click)="submitReason()"></button>
  </ng-template>
</p-dialog>

<p-dialog header="Assign Test" [(visible)]="showAssignTestDialog" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'520px', '640px':'95vw' }"
  [style]="{ width:'560px' }"
  [contentStyle]="{ 'max-height':'72vh','overflow-y':'auto','overflow-x':'hidden','padding-bottom':'0' }"
  (onHide)="assignTestForm.reset(); currentApp && resetAction(currentApp.id)" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Assign Test</span>

      <button class="dialog-close-btn" (click)="showAssignTestDialog = false">
        ✕
      </button>
    </div>
  </ng-template>
  <form [formGroup]="assignTestForm" class="at-body p-fluid">
    <div class="dialog-field">
      <label class="at-label">Evaluation Test <span class="at-req">*</span></label>

      <!-- Force overlay to body so it isn't clipped -->
      <p-select formControlName="testId" [options]="testsCatalog" optionLabel="name" optionValue="id"
        placeholder="Select a test" [filter]="true" [showClear]="true" appendTo="body"></p-select>
      <small class="at-hint" *ngIf="assignTestForm.get('testId')?.invalid && assignTestForm.touched">
        Please choose a test to assign.
      </small>
    </div>

 
      <div class="dialog-row">
        <!-- Test start -->
        <div class="dialog-field">
          <label class="at-label">Test date</label>
          <p-datepicker formControlName="testDateDate" appendTo="body"></p-datepicker>
        </div>
        <div class="dialog-field">
          <label class="at-label">Time</label>
          <p-datepicker formControlName="testDateTime" [timeOnly]="true" hourFormat="24" appendTo="body"></p-datepicker>
        </div>
      </div>

      <div class="dialog-row">
        <!-- Deadline -->
        <div class="dialog-field">
          <label class="at-label">Deadline date</label>
          <p-datepicker formControlName="deadlineDateDate" appendTo="body"></p-datepicker>
        </div>
        <div class="dialog-field">
          <label class="at-label">Time</label>
          <p-datepicker formControlName="deadlineDateTime" [timeOnly]="true" hourFormat="24"
            appendTo="body"></p-datepicker>
        </div>
      </div>

    
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" class="p-button-text" (click)="showAssignTestDialog=false"></button>
    <button pButton type="button" label="Assign" icon="pi pi-check"  [loading]="isLoading" [label]="isLoading ? 'Assigning': 'Assign'" (click)="submitAssignTest()"
      [disabled]="assignTestForm.invalid"></button>
  </ng-template>
</p-dialog>



<p-dialog header="Move to Shortlisted" [(visible)]="shortlistDlg.visible" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }"
  [style]="{ width:'480px' }" (onHide)="shortlistDlg.app && resetAction(shortlistDlg.app.id)" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Move to Shortlisted</span>

      <button class="dialog-close-btn" (click)="shortlistDlg.visible= false">
        ✕
      </button>
    </div>
  </ng-template>
  <div class="dialog-body">
    ️<p>Are you sure you want to move this application to <b>Shortlisted</b>?</p>
    <div class="field">
      <label class="label">Short List Reason <span class="req">*</span> </label>
      <textarea pInputTextarea [(ngModel)]="shortlistDlg.shortListNote" rows="4" autoResize="true"
        placeholder="Add a short note for future reference"></textarea>
      <!-- <small class="hint">This is the current stage of the application.</small> -->
    </div>
    <div class="field">
      <label class="label">Next Stage <span class="req">*</span></label>
      <div class="p-inputgroup">
        <span class="p-inputgroup-addon"><i class="pi pi-flag"></i></span>
        <input pInputText [(ngModel)]="shortlistDlg.stage" placeholder='e.g., "Tech Round 1"' />
      </div>
      <small class="hint">This label appears on the application as the current stage.</small>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="shortlistDlg.visible=false"></button>
    <button pButton label="Confirm" icon="pi pi-check" (click)="doShortlist()"
      [disabled]="!shortlistDlg.stage"></button>
  </ng-template>
</p-dialog>

<p-dialog header="Reject Application" [(visible)]="rejectDlg.visible" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }"
  [style]="{ width:'520px' }" (onHide)="rejectDlg.app && resetAction(rejectDlg.app.id)" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Reject Application</span>

      <button class="dialog-close-btn" (click)="rejectDlg.visible = false">
        ✕
      </button>
    </div>
  </ng-template>
  <div class="dialog-body p-fluid">
    <div class="field">
      <label class="label">Reason <span class="req">*</span></label>
      <p-select [options]="rejectReasonOptions" [(ngModel)]="rejectDlg.reason" optionLabel="label" optionValue="value"
        placeholder="Choose reason" appendTo="body" [showClear]="true"></p-select>
      <small class="hint">Pick the closest reason; add context below if needed.</small>
    </div>

    <div class="field">
      <label class="label">Notes <span class="muted">(optional)</span></label>
      <textarea pInputTextarea [(ngModel)]="rejectDlg.note" rows="4" autoResize="true"
        placeholder="Add a short note for future reference"></textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="rejectDlg.visible=false"></button>
    <button pButton label="Reject" icon="pi pi-times" (click)="doReject()" [disabled]="!rejectDlg.reason"></button>
  </ng-template>
</p-dialog>

<p-dialog header="Candidate Overview" [(visible)]="showSummaryDialog" [modal]="true" [dismissableMask]="true"
  [style]="{width: '700px'}" (onHide)="selectedAppId=null" [closable]="false" class="recruit">
  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Candidate Overview</span>

      <button class="dialog-close-btn" (click)="showSummaryDialog = false">
        ✕
      </button>
    </div>
  </ng-template>

  <app-candidate-summary *ngIf="selectedAppId" [applicationId]="selectedAppId"></app-candidate-summary>

  <ng-template pTemplate="footer">
    <button pButton label="Close" class="p-button-text" (click)="showSummaryDialog=false"></button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>