<div class="card">
  <h2>Application Status</h2>

  <div class="filters">
    <label>
      <span>Job</span>
      <select [(ngModel)]="selectedJobId" (change)="load()">
        <option [ngValue]="undefined">All jobs</option>
        <option *ngFor="let j of jobs" [ngValue]="j.id">{{ j.title }}</option>
      </select>
    </label>

    <label>
      <span>Status</span>
      <select [(ngModel)]="filterStatus" (change)="load()">
        <option [ngValue]="''">Any</option>
        <option
          *ngFor="let s of ['APPLIED','SCREENING','SHORTLISTED','INTERVIEW_SCHEDULED','INTERVIEWED','OFFERED','OFFER_ACCEPTED','OFFER_DECLINED','REJECTED','WITHDRAWN','HIRED','NO_SHOW']"
          [ngValue]="s">
          {{ s }}
        </option>
      </select>
    </label>

    <label class="grow">
      <span>Search</span>
      <input [(ngModel)]="q" (keyup.enter)="load()" placeholder="candidate or email" />
    </label>

    <button (click)="load()">Load</button>
  </div>

  <p-table [value]="apps" [scrollable]="true" scrollDirection="both" [scrollHeight]="'60vh'"
    [tableStyle]="{ 'min-width': '1200px' }" styleClass="p-datatable-gridlines p-datatable-striped">

    <ng-template pTemplate="header">
      <tr>
        <th>Candidate</th>
        <th>Job Title</th>
        <th>Status</th>
        <!-- <th>Stage</th> -->
        <th>Offer</th>
        <th>Resume</th>
        <th class="center">Actions</th>
        <th class="center">Overview</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-a>
      <tr>
        <td>
          <div class="name">{{ a.candidate?.name }}</div>
          <div class="email" [title]="a.candidate?.email">{{ a.candidate?.email }}</div>
        </td>
        <td [title]="a.job?.title">{{ a.job?.title }}</td>
        <td><span class="pill">{{ a.status }}</span></td>
        <!-- <td>{{ a.status || '—' }}</td> -->
        <td>{{ a.offer?.status || '—' }}</td>
        <td class="resume">
          <a *ngIf="resumeUrl(a)" [href]="resumeUrl(a)!" target="_blank" rel="noopener" pTooltip="View Resume"
            tooltipPosition="top">
            <i class="pi pi-external-link"></i>
          </a>
        </td>
        <td class="actions">
          <p-select [options]="actionOptionsFor(a)" [(ngModel)]="actionSel[a.id]" placeholder="Choose action"
            appendTo="body" [style]="{ width: '10rem' }"
            (onChange)="handleActionSelect(a, $event.value); actionSel[a.id]=null">
          </p-select>
        </td>
        <td>
          <button pButton 
          label="Overview" 
          icon="pi pi-eye" 
          class="p-button-text" 
          (click)="openSummaryDialog(a)">
  </button>
        </td>

      </tr>
      
    </ng-template>
  </p-table>


</div>
<!-- ... your existing table / page content ... -->

<!-- ====================== -->
<!-- Schedule Interview     -->
<!-- ====================== -->
<p-dialog header="Schedule Interview" [(visible)]="showInterviewDialog" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'48vw', '640px':'92vw' }" [style]="{ width:'640px' }"
  (onHide)="resetInterview()">
  <form [formGroup]="interviewForm" class="si-body p-fluid">
    <!-- Stage -->
    <div class="si-field">
      <label class="si-label">Stage <span class="si-req">*</span></label>
      <p-select formControlName="stage"
      [options]="[
        { label:'Panel', value:'Panel'},
        { label:'Management', value:'Management'}
      ]"
      placeholder="Choose stage">
    </p-select>
    
    </div>

    <!-- Time row -->
    <div class="si-row">
      <!-- Start -->
      <div class="si-col">
        <label class="si-label">Start <span class="si-req">*</span></label>
        <div class="si-input si-grid-2">
          <p-datepicker formControlName="startDate"  [showTime]="false" appendTo="body" ></p-datepicker>
          <p-datepicker formControlName="startTime" [showTime]="true" [timeOnly]="true" hourFormat="24"
            appendTo="body"></p-datepicker>
        </div>
      </div>

      <!-- End -->
      <div class="si-col">
        <label class="si-label">End <span class="si-req">*</span></label>
        <div class="si-input si-grid-2">
          <p-datepicker formControlName="endDate" [showTime]="false" appendTo="body"></p-datepicker>
          <p-datepicker formControlName="endTime" [showTime]="true" [timeOnly]="true" hourFormat="24"
            appendTo="body"></p-datepicker>
        </div>
      </div>

    </div>


    <p-divider class="si-divider"></p-divider>

    <!-- Panel multi-select -->
    <div class="si-field">
      <label class="si-label">Panel interviewers</label>
      <p-multiSelect [options]="panelOptions" formControlName="panelIds" defaultLabel="Select interviewers"
        [filter]="true" [showClear]="true" [display]="'chip'" appendTo="body"> <ng-template
          pTemplate="item" let-opt>
          <div class="option-row"> <i class="pi pi-user" style="margin-right:.5rem;"></i>
            <div>
              <div class="name">{{ opt.label }}</div> <small class="muted">ID: {{ opt.value }} · {{ opt.meta?.code
                }}</small>
            </div>
          </div>
        </ng-template> <ng-template pTemplate="selectedItems" let-values> <ng-container *ngIf="values?.length; else ph">
            <p-chip *ngFor="let v of values" [label]="panelLabelById(v)"></p-chip> </ng-container> <ng-template #ph>
            Select interviewers </ng-template> </ng-template> </p-multiSelect>

    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" class="p-button-text" (click)="showInterviewDialog=false"></button>
    <button pButton type="button" label="Save" icon="pi pi-check" (click)="submitInterview()"
      [disabled]="interviewForm.invalid"></button>
  </ng-template>
</p-dialog>



<!-- ====================== -->
<!-- Send Offer (optional date) -->
<!-- ====================== -->
<p-dialog header="Send Offer" [(visible)]="showOfferDialog" [modal]="true" [dismissableMask]="true" [draggable]="false"
  [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }" [style]="{ width:'420px' }"
  (onHide)="offerForm.reset()">
  <form [formGroup]="offerForm" class="dialog-body p-fluid">
    <div class="field">
      <label class="label">Proposed Join <span class="muted">(optional)</span></label>
      <p-datepicker formControlName="proposedJoinAt" [showTime]="true" hourFormat="24"></p-datepicker>
      <small class="hint">You can leave this blank and set it later.</small>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Skip" class="p-button-text" (click)="submitOffer(true)"></button>
    <button pButton type="button" label="Send" icon="pi pi-send" (click)="submitOffer(false)"></button>
  </ng-template>
</p-dialog>


<!-- ====================== -->
<!-- Reason (Decline / No-show) -->
<!-- ====================== -->
<p-dialog [header]="reasonDialogTitle" [(visible)]="showReasonDialog" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }" [style]="{ width:'480px' }"
  (onHide)="reasonForm.reset()">
  <form [formGroup]="reasonForm" class="dialog-body p-fluid">
    <div class="field">
      <label class="label">{{ reasonDialogLabel }}</label>
      <textarea pInputTextarea rows="4" autoResize="true" formControlName="reason"
        placeholder="Add a brief reason"></textarea>
      <small class="hint">
        Be concise; this will be visible in the application timeline.
        <span class="muted" *ngIf="reasonForm.get('reason')?.value?.length">
          ({{ reasonForm.get('reason')?.value?.length }} chars)
        </span>
      </small>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" class="p-button-text" (click)="showReasonDialog=false"></button>
    <button pButton type="button" label="Save" icon="pi pi-check" (click)="submitReason()"></button>
  </ng-template>
</p-dialog>

<p-dialog header="Assign Test" [(visible)]="showAssignTestDialog" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'520px', '640px':'95vw' }"
  [style]="{ width:'560px' }"
  [contentStyle]="{ 'max-height':'72vh','overflow-y':'auto','overflow-x':'hidden','padding-bottom':'0' }"
  (onHide)="assignTestForm.reset()">
  <form [formGroup]="assignTestForm" class="at-body p-fluid">
    <div class="at-field">
      <label class="at-label">Evaluation Test <span class="at-req">*</span></label>

      <!-- Force overlay to body so it isn't clipped -->
      <p-select formControlName="testId" [options]="testsCatalog" optionLabel="name" optionValue="id"
        placeholder="Select a test" [filter]="true" [showClear]="true" appendTo="body"></p-select>
      <small class="at-hint" *ngIf="assignTestForm.get('testId')?.invalid && assignTestForm.touched">
        Please choose a test to assign.
      </small>
    </div>

    <div class="at-row">
      <div class="at-row">
        <!-- Test start -->
        <div class="at-col">
          <label class="at-label">Test date</label>
          <p-datepicker formControlName="testDateDate" appendTo="body"></p-datepicker>
        </div>
        <div class="at-col">
          <label class="at-label">Time</label>
          <p-datepicker formControlName="testDateTime" [timeOnly]="true" hourFormat="24" appendTo="body"></p-datepicker>
        </div>
      </div>

      <div class="at-row">
        <!-- Deadline -->
        <div class="at-col">
          <label class="at-label">Deadline date</label>
          <p-datepicker formControlName="deadlineDateDate" appendTo="body"></p-datepicker>
        </div>
        <div class="at-col">
          <label class="at-label">Time</label>
          <p-datepicker formControlName="deadlineDateTime" [timeOnly]="true" hourFormat="24"
            appendTo="body"></p-datepicker>
        </div>
      </div>

    </div>
  </form>

  <ng-template pTemplate="footer">
    <button pButton type="button" label="Cancel" class="p-button-text" (click)="showAssignTestDialog=false"></button>
    <button pButton type="button" label="Assign" icon="pi pi-check" (click)="submitAssignTest()"
      [disabled]="assignTestForm.invalid"></button>
  </ng-template>
</p-dialog>



<p-dialog header="Move to Shortlisted" [(visible)]="shortlistDlg.visible" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }"
  [style]="{ width:'480px' }">
  <div class="dialog-body">
    ️<p>Are you sure you want to move this application to <b>Shortlisted</b>?</p>
    <div class="field">
      <label class="label">Short List Reason <span class="req">*</span> </label>
      <textarea pInputTextarea [(ngModel)]="shortlistDlg.shortListNote" rows="4" autoResize="true"
        placeholder="Add a short note for future reference"></textarea>
      <!-- <small class="hint">This is the current stage of the application.</small> -->
    </div>
    <div class="field">
      <label class="label">Next Stage <span class="req">*</span></label>
      <div class="p-inputgroup">
        <span class="p-inputgroup-addon"><i class="pi pi-flag"></i></span>
        <input pInputText [(ngModel)]="shortlistDlg.stage" placeholder='e.g., "Tech Round 1"' />
      </div>
      <small class="hint">This label appears on the application as the current stage.</small>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="shortlistDlg.visible=false"></button>
    <button pButton label="Confirm" icon="pi pi-check" (click)="doShortlist()"
      [disabled]="!shortlistDlg.stage"></button>
  </ng-template>
</p-dialog>

<p-dialog header="Reject Application" [(visible)]="rejectDlg.visible" [modal]="true" [dismissableMask]="true"
  [draggable]="false" [resizable]="false" [breakpoints]="{ '960px':'50vw', '640px':'90vw' }"
  [style]="{ width:'520px' }">
  <div class="dialog-body p-fluid">
    <div class="field">
      <label class="label">Reason <span class="req">*</span></label>
      <p-select [options]="rejectReasonOptions" [(ngModel)]="rejectDlg.reason" optionLabel="label" optionValue="value"
        placeholder="Choose reason" appendTo="body" [showClear]="true"></p-select>
      <small class="hint">Pick the closest reason; add context below if needed.</small>
    </div>

    <div class="field">
      <label class="label">Notes <span class="muted">(optional)</span></label>
      <textarea pInputTextarea [(ngModel)]="rejectDlg.note" rows="4" autoResize="true"
        placeholder="Add a short note for future reference"></textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="rejectDlg.visible=false"></button>
    <button pButton label="Reject" icon="pi pi-times" (click)="doReject()" [disabled]="!rejectDlg.reason"></button>
  </ng-template>
</p-dialog>

<p-dialog 
  header="Candidate Overview" 
  [(visible)]="showSummaryDialog" 
  [modal]="true" 
  [dismissableMask]="true" 
  [style]="{width: '700px'}"
  (onHide)="selectedAppId=null">

  <app-candidate-summary *ngIf="selectedAppId" [applicationId]="selectedAppId"></app-candidate-summary>

  <ng-template pTemplate="footer">
    <button pButton label="Close" class="p-button-text" (click)="showSummaryDialog=false"></button>
  </ng-template>
</p-dialog>
