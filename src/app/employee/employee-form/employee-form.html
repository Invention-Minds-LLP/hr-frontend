<div class="employee-form-container">

    <!-- <p-steps [model]="steps" [(activeIndex)]="activeIndex" class="mb-3"></p-steps> -->
    <!-- <div class="step-container">
        <p-steps [model]="steps" [(activeIndex)]="activeIndex" class="mb-3">
            <ng-template pTemplate="item" let-item let-index="index">
                <a class="p-menuitem-link" [ngClass]="{'completed-step': completedSteps[index]}">
                    <span class="p-steps-number">{{index + 1}}</span>
                    <span class="p-steps-title">{{item.label}}</span>
                </a>
            </ng-template>
        </p-steps>

    </div> -->

    <div class="card">
        <form [formGroup]="employeeForm" (ngSubmit)="onSubmit()">
            <p-stepper [value]="1">

                <!-- Step 1: Personal Info -->
                <p-step-item [value]="1">
                    <p-step>Personal Info</p-step>
                    <p-step-panel>
                        <ng-template #content let-activateCallback="activateCallback">
                            <div [hidden]="activeIndex !== 0" class="personal-container"
                                [class.active-step]="activeIndex === 0">
                                <div class="p-fluid formgrid grid">
                                    <div class="field-row col-12">
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input id="firstName" pInputText formControlName="firstName"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('firstName'))}" />
                                                <label for="firstName">First Name</label>

                                            </p-floatlabel>

                                            <div *ngIf="showError(employeeForm.get('firstName'))">
                                                <small class="error-msg">First name is required</small>
                                            </div>
                                        </div>

                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input id="lastName" pInputText formControlName="lastName"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('lastName'))}" />
                                                <label for="lastName">Last Name</label>
                                            </p-floatlabel>
                                            <div class="error-msg" *ngIf="showError(employeeForm.get('lastName'))">
                                                Last Name
                                                is
                                                required</div>
                                        </div>

                                        <div class="field col-4">
                                            <p-floatlabel variant="on" style="width:100%">
                                                <label for="dob">Date of Birth</label>
                                                <p-datePicker id="dob" formControlName="dob" dateFormat="yy-mm-dd"
                                                    showIcon iconDisplay="input"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('dob'))}"></p-datePicker>
                                                <div class="error-msg" *ngIf="showError(employeeForm.get('dob'))">
                                                    Date of
                                                    Birth is
                                                    required</div>
                                            </p-floatlabel>
                                        </div>
                                    </div>

                                    <div class="field-row col-12">

                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-select id="gender" [options]="genders" formControlName="gender"
                                                    optionLabel="label" optionValue="value"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('gender'))}"></p-select>
                                                <label for="gender">Gender</label>
                                                <div class="error-msg" *ngIf="showError(employeeForm.get('gender'))">
                                                    Gender
                                                    is required
                                                </div>
                                            </p-floatLabel>
                                        </div>

                                        <div class="field col-4">
                                            <p-floatLabel variant="on">

                                                <input id="email" pInputText formControlName="email"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('email'))}" />
                                                <label for="email">Email</label>
                                                <div class="error-msg" *ngIf="showError(employeeForm.get('email'))">
                                                    Email ID
                                                    is required
                                                </div>
                                            </p-floatLabel>
                                        </div>

                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <input id="phone" pInputText formControlName="phone"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('phone'))}"
                                                    maxlength="10" />
                                                <label for="phone">Phone</label>
                                                <div class="error-msg" *ngIf="showError(employeeForm.get('phone'))">
                                                    Phone
                                                    Number is
                                                    required</div>
                                            </p-floatLabel>
                                        </div>
                                    </div>
                                    <div class="field-row col-12">
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-select id="bloodGroup" [options]="bloodGroups"
                                                    formControlName="bloodGroup" optionLabel="label" optionValue="value"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('bloodGroup'))}">
                                                </p-select>
                                                <label for="bloodGroup">Blood Group</label>
                                                <div class="error-msg"
                                                    *ngIf="showError(employeeForm.get('bloodGroup'))">
                                                    Blood Group is required
                                                </div>
                                            </p-floatLabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <input id="age" pInputText formControlName="age" readonly />
                                                <label for="age">Age</label>
                                            </p-floatLabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-select [options]="[
                                      { label: 'Clinical', value: 'CLINICAL' },
                                      { label: 'Non-clinical', value: 'NONCLINICAL' }
                                    ]" formControlName="employeeType"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get('employeeType'))}"></p-select>
                                                <label>Employee Type</label>
                                            </p-floatLabel>
                                            <div class="error-msg" *ngIf="showError(employeeForm.get('employeeType'))">
                                                Employee Type
                                                is required
                                            </div>
                                        </div>


                                    </div>

                                    <div class="heading mb-2">Permanent Address</div>
                                    <div class="p-fluid formgrid grid" formGroupName="permanentAddress">
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="line1"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get(['permanentAddress','line1']))}" />
                                                <label>Address Line 1</label>
                                                <div class="error-msg"
                                                    *ngIf="showError(employeeForm.get(['permanentAddress','line1']))">
                                                    Address is
                                                    required </div>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="city"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get(['permanentAddress','city']))}" />
                                                <label>City</label>
                                                <div class="error-msg"
                                                    *ngIf="showError(employeeForm.get(['permanentAddress','city']))">
                                                    City is required </div>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="state"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get(['permanentAddress','state']))}" />
                                                <label>State</label>
                                                <div class="error-msg"
                                                    *ngIf="showError(employeeForm.get(['permanentAddress','state']))">
                                                    State
                                                    is required
                                                </div>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="zipCode"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get(['permanentAddress','zipCode']))}" />
                                                <label>Zip Code</label>
                                                <div class="error-msg"
                                                    *ngIf="showError(employeeForm.get(['permanentAddress','zipCode']))">
                                                    zipCode id
                                                    required </div>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="country"
                                                    [ngClass]="{'ng-invalid': showError(employeeForm.get(['permanentAddress','country']))}" />
                                                <label>Country</label>
                                                <div class="error-msg"
                                                    *ngIf="showError(employeeForm.get(['permanentAddress','country']))">
                                                    Country is
                                                    required </div>
                                            </p-floatlabel>
                                        </div>
                                    </div>

                                    <div
                                        class="heading mb-2 mt-3  flex align-items-center gap-2 justify-content-between">
                                        Temporary Address
                                        <p-checkbox binary="true" formControlName="sameAsPermanent"
                                            label="Same as Permanent" (onChange)="copyPermanentAddress()">
                                        </p-checkbox>

                                    </div>
                                    <div class="p-fluid formgrid grid" formGroupName="temporaryAddress">
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="line1" />
                                                <label>Address Line 1</label>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="city" />
                                                <label>City</label>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="state" />
                                                <label>State</label>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="zipCode" />
                                                <label>Zip Code</label>
                                            </p-floatlabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatlabel variant="on">
                                                <input pInputText formControlName="country" />
                                                <label>Country</label>
                                            </p-floatlabel>
                                        </div>
                                    </div>



                                    <div class="field col-12">
                                        <div class="heading mb-2">
                                            Emergency Contact
                                        </div>
                                        <div formArrayName="emergencyContacts">
                                            <div *ngFor="let ec of emergencyContacts.controls; let i = index"
                                                [formGroupName]="i" class="p-fluid flex1 mb-3 mt-3">
                                                <div class="field-row">
                                                    <div class="field col-4">
                                                        <p-floatLabel variant="on">
                                                            <input pInputText formControlName="name" id="emergencyName"
                                                                placeholder=""
                                                                [ngClass]="{ 'ng-invalid': showError(ec.get('name')) }" />
                                                            <label>Name</label>
                                                            <div class="error-msg" *ngIf="showError(ec.get('name'))">
                                                                Name is required
                                                            </div>
                                                        </p-floatLabel>
                                                    </div>

                                                    <div class="field col-4">
                                                        <p-floatLabel variant="on">
                                                            <input pInputText formControlName="phone"
                                                                id="emergencyPhone" placeholder=""
                                                                [ngClass]="{ 'ng-invalid': showError(ec.get('phone')) }" />
                                                            <label>Phone</label>
                                                            <div class="error-msg" *ngIf="showError(ec.get('phone'))">
                                                                Phone Number is required
                                                            </div>
                                                        </p-floatLabel>
                                                    </div>

                                                    <div class="field col-4">
                                                        <p-floatLabel variant="on">
                                                            <input pInputText formControlName="relationship"
                                                                id="emergencyRelationship" placeholder=""
                                                                [ngClass]="{ 'ng-invalid': showError(ec.get('relationship')) }" />
                                                            <label>Relationship</label>
                                                            <div class="error-msg"
                                                                *ngIf="showError(ec.get('relationship'))">
                                                                Relationship is required
                                                            </div>
                                                        </p-floatLabel>
                                                    </div>
                                                </div>

                                                <div class="flex1">
                                                    <div class="">
                                                        <button pButton variant="outlined" type="button" label="Remove"
                                                            (click)="removeEmergencyContact(i)"
                                                            class="p-button-danger"></button>
                                                    </div>
                                                    <div class="col-12 ">
                                                        <button pButton variant="outlined" severity="danger"
                                                            type="button" label="+ Add" (click)="addEmergencyContact()"
                                                            class="p-button-secondary"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                    <!-- 
                <div class="field col-12">
                    <div class="heading mb-3 mt-3">
                        Profile Photo
                    </div>
                    <p-fileUpload name="photo" [customUpload]="true"
                        (uploadHandler)="customPhotoUpload($event)"></p-fileUpload>
                </div> -->

                                </div>
                                <div class="col-3 flex justify-content-center align-items-start">
                                    <div class="profile-pic-container">
                                        <!-- Circular Image -->
                                        <img *ngIf="photoUrl; else placeholder" [src]="photoUrl" class="profile-pic" />
                                        <ng-template #placeholder>
                                            <div class="profile-placeholder">
                                                <i class="pi pi-user"></i>
                                            </div>
                                        </ng-template>

                                        <!-- Upload Icon -->
                                        <label class="upload-btn">
                                            <i class="pi pi-upload"></i>
                                            <input type="file" accept="image/*" (change)="onProfileSelect($event)"
                                                hidden />
                                        </label>

                                        <!-- Remove Icon -->
                                        <button type="button" class="remove-btn" *ngIf="photoUrl"
                                            (click)="removeProfilePhoto()">
                                            <i class="pi pi-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="py-6 btn">
                                <p-button label="Next" (onClick)="activateCallback(2)" />
                            </div> -->
                            <div class="py-6 btn">
                                <p-button label="Next" (onClick)="goToStep(2, activateCallback)" />
                            </div>

                        </ng-template>
                    </p-step-panel>
                </p-step-item>

                <!-- Step 2: Employment Info -->
                <p-step-item [value]="2">
                    <p-step>Employment Info</p-step>
                    <p-step-panel>
                        <ng-template #content let-activateCallback="activateCallback">
                            <!-- <div [hidden]="activeIndex !== 1" [class.active-step]="activeIndex === 1"> -->
                            <div class="p-fluid grid formgrid">
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="employeeCode"
                                            placeholder="Leave blank for auto-generation"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('employeeCode')) }" />
                                        <label>Employee Code</label>
                                        <!-- <div class="error-msg" *ngIf="showError(employeeForm.get('employeeCode'))">
                                            Employee Code is required.
                                        </div> -->
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="referenceCode" />
                                        <label>Reference Code</label>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="designation"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('designation')) }" />
                                        <label>Designation</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('designation'))">
                                            Designation is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-datePicker formControlName="dateOfJoining" dateFormat="yy-mm-dd" showIcon
                                            iconDisplay="input"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('dateOfJoining')) }"></p-datePicker>
                                        <label>Date of Joining</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('dateOfJoining'))">
                                            Date of Joining is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="employmentTypes" formControlName="employmentType"
                                            optionLabel="label" optionValue="value"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('employmentType')) }"></p-select>
                                        <label>Employment Type</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('employmentType'))">
                                            Employment Type is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4"
                                    *ngIf="employeeForm.get('employmentType')?.value === 'PROBATION'">
                                    <p-floatLabel variant="on">
                                        <p-datepicker formControlName="probationEndDate" [minDate]="today"
                                            dateFormat="dd M yy" inputId="probEndDate" [showIcon]="true"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('probationEndDate')) }">
                                        </p-datepicker>
                                        <label for="probEndDate">Probation End Date</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('probationEndDate'))">
                                            Probation end date is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="employmentStatuses" formControlName="employmentStatus"
                                            optionLabel="label" optionValue="value"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('employmentStatus')) }"></p-select>
                                        <label>Employment Status</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('employmentStatus'))">
                                            Employment Status is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="departments" formControlName="departmentId"
                                            optionLabel="name" optionValue="id"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('departmentId')) }"></p-select>
                                        <label>Department</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('departmentId'))">
                                            Department is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="branches" formControlName="branchId" optionLabel="name"
                                            optionValue="id"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('branchId')) }"></p-select>
                                        <label>Branch</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('branchId'))">
                                            Branch is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="roles" formControlName="roleId" optionLabel="name"
                                            optionValue="id"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('roleId')) }"></p-select>
                                        <label>Role</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('roleId'))">
                                            Role is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="reportingManagers" formControlName="reportingManager"
                                            optionLabel="label" optionValue="value"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('reportingManager')) }"></p-select>
                                        <label>Reporting Manager</label>
                                        <div class="error-msg" *ngIf="showError(employeeForm.get('reportingManager'))">
                                            Reporting Manager is required.
                                        </div>
                                    </p-floatLabel>
                                </div>
                                <!-- Shift Mode -->
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select
                                            [options]="[{label:'General', value:'FIXED'},{label:'Rotational', value:'ROTATIONAL'}]"
                                            formControlName="shiftMode"></p-select>
                                        <label>Shift Mode</label>
                                    </p-floatLabel>
                                </div>

                                <!-- If FIXED: choose a single template -->
                                <div class="field col-4" *ngIf="employeeForm.value.shiftMode === 'FIXED'">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="shifts" formControlName="shiftId" optionLabel="name"
                                            optionValue="id"
                                            [ngClass]="{ 'ng-invalid': showError(employeeForm.get('shiftId')) }"></p-select>
                                        <label>Shift Template</label>
                                    </p-floatLabel>
                                </div>

                                <!-- If ROTATIONAL: choose a pattern and start date -->
                                <div class="field col-4" *ngIf="employeeForm.value.shiftMode === 'ROTATIONAL'">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="patterns" formControlName="rotationPatternId"
                                            optionLabel="name" optionValue="id"></p-select>
                                        <label>Rotation Pattern</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-4" *ngIf="employeeForm.value.shiftMode === 'ROTATIONAL'">
                                    <p-floatLabel variant="on">
                                        <p-datePicker formControlName="rotationStartDate" showIcon iconDisplay="input"
                                            dateFormat="yy-mm-dd"></p-datePicker>
                                        <label>Rotation Start Date</label>
                                    </p-floatLabel>
                                </div>

                                <!-- <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-datePicker formControlName="shiftDate" dateFormat="yy-mm-dd" showIcon
                                            iconDisplay="input"></p-datePicker>
                                        <label>Shift Date</label>
                                    </p-floatLabel>
                                </div> -->
                            </div>
                            <!-- </div> -->
                            <div class="flex py-6 gap-2 btn">
                                <p-button label="Previous" severity="secondary" (onClick)="activateCallback(1)" />
                                <p-button label="Next" (onClick)="goToStep(3, activateCallback)" />
                            </div>

                        </ng-template>
                    </p-step-panel>
                </p-step-item>

                <!-- Step 3: Qualifications -->
                <p-step-item [value]="3">
                    <p-step>Qualifications</p-step>
                    <p-step-panel>
                        <ng-template #content let-activateCallback="activateCallback">
                            <!-- <div [hidden]="activeIndex !== 2" [class.active-step]="activeIndex === 2"> -->
                            <div formArrayName="qualifications" class="qualification">
                                <div class="mb-5">
                                    <button pButton variant="outlined" type="button" label="+ Add Qualification"
                                        (click)="addQualification()" class="p-button-secondary"></button>
                                </div>
                                <div *ngFor="let q of qualifications.controls; let i = index" [formGroupName]="i"
                                    class="p-fluid grid mb-3 formgrid">
                                    <div class="field col-5">
                                        <p-floatLabel variant="on">
                                            <p-select [options]="qualificationTypes" formControlName="degree"
                                                optionLabel="label"
                                                [ngClass]="{ 'ng-invalid': showError(q.get('degree')) }"
                                                optionValue="value">
                                            </p-select>
                                            <label>Qualification Type</label>
                                        </p-floatLabel>
                                        <div class="error-msg text-danger" *ngIf="showError(q.get('degree'))">Degree
                                            is
                                            required.
                                        </div>
                                    </div>
                                    <div class="field col-5"
                                        *ngIf="['BACHELOR','MASTER','OTHER'].includes(q.value.degree)">
                                        <p-floatLabel variant="on">
                                            <input pInputText formControlName="degreeName"
                                                placeholder="Degree Name (e.g., B.Tech, MBA)" />
                                            <label>Degree Name</label>
                                        </p-floatLabel>
                                    </div>

                                    <div class="field col-5">
                                        <input pInputText formControlName="institution" placeholder="Institution"
                                            [ngClass]="{ 'ng-invalid': showError(q.get('institution')) }" />
                                        <div class="error-msg text-danger" *ngIf="showError(q.get('institution'))">
                                            Institution is
                                            required.</div>
                                    </div>

                                    <div class="field col-5">
                                        <input pInputText type="number" formControlName="year" placeholder="Year"
                                            [ngClass]="{ 'ng-invalid': showError(q.get('year')) }" />
                                        <div class="error-msg text-danger" *ngIf="showError(q.get('year'))">
                                            Year is required.
                                        </div>
                                    </div>

                                    <div class="field col-5">
                                        <input pInputText type="text" formControlName="grade" placeholder="Grade" />
                                    </div>


                                    <div class="field col-5 trash-btn">
                                        <button variant="outlined" severity="danger" pButton type="button"
                                            icon="pi pi-trash" (click)="removeQualification(i)"
                                            class="p-button-danger p-button-rounded p-button-text">
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- </div> -->
                            <div class="flex py-6 gap-2 btn">
                                <p-button label="Previous" severity="secondary" (onClick)="activateCallback(2)" />
                                <p-button label="Next" (onClick)="goToStep(4, activateCallback)" />
                            </div>

                        </ng-template>
                    </p-step-panel>
                </p-step-item>


                <p-step-item [value]="4">
                    <p-step>Documents</p-step>
                    <p-step-panel>
                        <ng-template #content let-activateCallback="activateCallback">
                            <div class="mandatory-note">
                                <strong>Note:</strong> The following documents are mandatory based on employee type:
                                <ul>
                                    <li *ngFor="let doc of getMandatoryDocs().required">
                                        {{ doc }}
                                        <span *ngIf="getMandatoryDocs().missing.includes(doc)"
                                            class="missing">(Missing)</span>
                                    </li>
                                </ul>
                            </div>

                            <!-- <div [hidden]="activeIndex !== 3" [class.active-step]="activeIndex === 3"> -->
                            <div formArrayName="documents" class="qualification">

                                <!-- Add Document Button -->
                                <div class="mb-5">
                                    <button variant="outlined" severity="danger" pButton type="button"
                                        label="+ Add Document" (click)="addDocument()" class="p-button-secondary">
                                    </button>
                                </div>
                                <div *ngFor="let doc of uploadedDocsForm.controls; let i = index" [formGroupName]="i"
                                    class="p-fluid grid mb-3 formgrid">

                                    <!-- Category -->
                                    <div class="field col-2">
                                        <p-floatLabel variant="on">
                                            <p-select [options]="documentCategories" formControlName="category"
                                                optionLabel="label" optionValue="value"
                                                (onChange)="filterDocumentTypes(i)"
                                                [ngClass]="{'ng-invalid':showError(doc.get('category'))}">
                                            </p-select>
                                            <label>Category</label>
                                            <div class="error-msg" *ngIf="showError(doc.get('category'))">Category
                                                is
                                                required.
                                            </div>
                                        </p-floatLabel>
                                    </div>

                                    <!-- Document Type -->
                                    <div class="field col-2">
                                        <p-floatLabel variant="on">
                                            <p-select [options]="filteredTypes[i]" formControlName="type"
                                                optionLabel="label" optionValue="value"
                                                [ngClass]="{'ng-invalid':showError(doc.get('type'))}">
                                            </p-select>
                                            <label>Document Type</label>
                                            <div class="error-msg" *ngIf="showError(doc.get('type'))">Document Type
                                                is
                                                required
                                            </div>
                                        </p-floatLabel>
                                    </div>

                                    <!-- Issue Date -->
                                    <div class="field col-2">
                                        <p-floatLabel variant="on">

                                            <p-datePicker formControlName="issueDate" showIcon iconDisplay="input"
                                                dateFormat="yy-mm-dd"></p-datePicker>
                                            <label>Issue Date</label>
                                        </p-floatLabel>
                                    </div>

                                    <!-- Expiry Date -->
                                    <div class="field col-2">
                                        <p-floatLabel variant="on">

                                            <p-datePicker formControlName="expiryDate" showIcon iconDisplay="input"
                                                dateFormat="yy-mm-dd"></p-datePicker>
                                            <label>Expiry Date</label>
                                        </p-floatLabel>
                                    </div>

                                    <!-- File Upload -->
                                    <div class="field col-2">
                                        <div class="file-upload-wrapper relative">
                                            <input type="file" class="custom-file-input" title="{{
                                        uploadedDocsForm.at(i).value.file?.name ||
                                    uploadedDocsForm.at(i).value.fileUrl?.split('/').pop()
                                  }}" [attr.data-file-name]="
                                    uploadedDocsForm.at(i).value.file?.name ||
                                    uploadedDocsForm.at(i).value.fileUrl?.split('/').pop() ||
                                    'Choose File'
                                  " (change)="onDocumentSelect($event, i)"
                                                [ngClass]="{ 'ng-invalid': showError(doc.get('file')) }" />
                                            <i class="pi pi-upload"></i>
                                        </div>
                                        <div class="error-msg" *ngIf="showError(doc.get('file'))">
                                            File is required.
                                        </div>

                                    </div>



                                    <!-- Remove -->
                                    <div class="field col-1 flex align-items-center trash-btn">
                                        <button variant="outlined" severity="danger" pButton type="button"
                                            icon="pi pi-trash" class="p-button-danger p-button-rounded p-button-text"
                                            (click)="removeDocument(i)">
                                        </button>
                                    </div>

                                    <!-- Preview (image or link)
                                    <div class="field col-12" *ngIf="getDocPreview(i) as p">
                                        <div class="doc-preview" [ngSwitch]="p.kind">
                                            <img *ngSwitchCase="'image'" [src]="p.src" alt="Document preview"
                                                class="doc-img" />
                                        </div>
                                    </div> -->

                                    <!-- View Document Link -->
                                    <div class="field col-12" *ngIf="uploadedDocsForm.at(i).value.fileUrl">
                                        <a href="javascript:void(0)" class="view-link" (click)="openDocPopup(i)">
                                            <i class="pi pi-eye"></i> View Document
                                        </a>
                                    </div>


                                </div>

                            </div>

                            <!-- </div> -->
                            <div class="flex py-6 gap-2 btn">
                                <p-button label="Previous" severity="secondary" (onClick)="activateCallback(3)" />
                                <div class="py-6 btn">
                                    <p-button label="Next" (onClick)="goToStep(5, activateCallback)" />
                                </div>
                            </div>
                        </ng-template>
                    </p-step-panel>
                </p-step-item>
                <!-- Step 5: Health & Wellness -->
                <p-step-item [value]="5">
                    <p-step>Health & Wellness</p-step>
                    <p-step-panel>
                        <ng-template #content let-activateCallback="activateCallback">

                            <!-- Pre-Employment Check -->
                            <div class="heading mb-2">Pre-Employment Health Check</div>
                            <div class="field col-4">
                                <p-floatLabel variant="on">
                                    <p-datePicker formControlName="preEmploymentCheckDate" showIcon iconDisplay="input"
                                        dateFormat="yy-mm-dd"></p-datePicker>
                                    <label>Pre-Employment Check Date</label>
                                </p-floatLabel>
                            </div>

                            <!-- General Health Info -->
                            <div class="heading mb-2 mt-3">General Health Information</div>
                            <div class="p-fluid grid formgrid">
                                <div class="field col-3">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="height" id="height" />
                                        <label for="height">Height (cm)</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-3">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="weight" id="weight" />
                                        <label for="weight">Weight (kg)</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-3">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="bmi" id="bmi" readonly />
                                        <label for="bmi">BMI</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-3">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="bloodPressure" id="bloodPressure" />
                                        <label for="bloodPressure">Blood Pressure (e.g., 120/80)</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-3">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="bloodSugar" id="bloodSugar" />
                                        <label for="bloodSugar">Blood Sugar (mg/dL)</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-3">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="cholesterol" id="cholesterol" />
                                        <label for="cholesterol">Cholesterol (mg/dL)</label>
                                    </p-floatLabel>
                                </div>
                            </div>

                            <!-- Allergies & Chronic Conditions -->
                            <div class="heading mb-2 mt-3">Medical History</div>
                            <div class="p-fluid grid formgrid">
                                <div class="field col-6">
                                    <p-floatLabel variant="on">
                                        <textarea pInputTextarea formControlName="allergies"></textarea>
                                        <label>Allergies</label>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-6">
                                    <p-floatLabel variant="on">
                                        <textarea pInputTextarea formControlName="chronicConditions"></textarea>
                                        <label>Chronic Conditions</label>
                                    </p-floatLabel>
                                </div>
                            </div>

                            <!-- Lifestyle -->
                            <div class="heading mb-2 mt-3">Lifestyle</div>
                            <div class="p-fluid grid formgrid">
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="[{label:'Yes', value:true},{label:'No', value:false}]"
                                            formControlName="smoking"></p-select>
                                        <label>Smoker</label>
                                    </p-floatLabel>
                                </div>
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="[{label:'Yes', value:true},{label:'No', value:false}]"
                                            formControlName="alcohol"></p-select>
                                        <label>Consumes Alcohol</label>
                                    </p-floatLabel>
                                </div>
                            </div>

                            <!-- Ophthalmology Info -->
                            <div class="heading mb-2 mt-3">Ophthalmology</div>
                            <div class="p-fluid grid formgrid">
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="[
          {label:'Normal', value:'NORMAL'},
          {label:'Short-sighted (Myopia)', value:'MYOPIA'},
          {label:'Long-sighted (Hypermetropia)', value:'HYPERMETROPIA'},
          {label:'Other', value:'OTHER'}
        ]" formControlName="visionType">
                                        </p-select>
                                        <label>Vision Type</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="[{label:'Yes', value:true},{label:'No', value:false}]"
                                            formControlName="usesGlasses">
                                        </p-select>
                                        <label>Uses Glasses or Contact Lens</label>
                                    </p-floatLabel>
                                </div>

                                <div class="field col-4" *ngIf="employeeForm.get('visionType')?.value === 'OTHER'">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="visionRemarks" />
                                        <label>Other Vision Details</label>
                                    </p-floatLabel>
                                </div>
                            </div>

                            <!-- Surgery History -->
                            <div class="heading mb-2 mt-3">Surgery History</div>
                            <div class="p-fluid grid formgrid">
                                <div class="field col-12">
                                    <p-floatLabel variant="on">
                                        <textarea pInputTextarea formControlName="pastSurgeries" rows="3"></textarea>
                                        <label>Previous Surgeries (if any)</label>
                                    </p-floatLabel>
                                </div>
                            </div>

                            <!-- Disability Information -->
                            <div class="heading mb-2 mt-3">Disability Information</div>
                            <div class="p-fluid grid formgrid">
                                <!-- Has Disability -->
                                <div class="field col-4">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="[{label:'Yes', value:true}, {label:'No', value:false}]"
                                            formControlName="hasDisability">
                                        </p-select>
                                        <label>Any Disability</label>
                                    </p-floatLabel>
                                </div>

                                <!-- Type of Disability -->
                                <div class="field col-4" *ngIf="employeeForm.get('hasDisability')?.value">
                                    <p-floatLabel variant="on">
                                        <p-select [options]="[
          {label:'Physical', value:'PHYSICAL'},
          {label:'Visual', value:'VISUAL'},
          {label:'Hearing', value:'HEARING'},
          {label:'Cognitive', value:'COGNITIVE'},
          {label:'Other', value:'OTHER'}
        ]" formControlName="disabilityType">
                                        </p-select>
                                        <label>Disability Type</label>
                                    </p-floatLabel>
                                </div>

                                <!-- Disability Description -->
                                <div class="field col-4" *ngIf="employeeForm.get('hasDisability')?.value">
                                    <p-floatLabel variant="on">
                                        <input pInputText formControlName="disabilityDescription" />
                                        <label>Disability Description / Assistance Needed</label>
                                    </p-floatLabel>
                                </div>

                                <!-- Disability Certificate Upload -->
                                <div class="field col-6 mt-2" *ngIf="employeeForm.get('hasDisability')?.value">
                                    <div class="file-upload-wrapper relative">
                                        <input type="file" class="custom-file-input"
                                            (change)="onDisabilityProofSelect($event)" />
                                        <!-- <small *ngIf="employeeForm.get('disabilityProofFileName')?.value">
                                            {{ employeeForm.get('disabilityProofFileName')?.value }}
                                        </small> -->
                                        <ng-container *ngIf="employeeForm.get('disabilityProofUrl')?.value">
                                            <a [href]="employeeForm.get('disabilityProofUrl')?.value" target="_blank"
                                                rel="noopener noreferrer" style="text-wrap: nowrap; padding-left:20px">
                                                <i class="pi pi-file"></i> View Proof
                                            </a>
                                        </ng-container>
                                    </div>
                                </div>
                            </div>



                            <!-- Health Issues -->
                            <div class="heading mb-2 mt-3">Health Issues</div>
                            <div formArrayName="healthIssues">
                                <div class="mb-3">
                                    <button pButton type="button" label="+ Add Health Issue" class="p-button-secondary"
                                        (click)="addHealthIssue()"></button>
                                </div>
                                <div *ngFor="let issue of healthIssues.controls; let i = index" [formGroupName]="i"
                                    class="p-fluid grid formgrid mb-2">
                                    <div class="field col-3">
                                        <p-floatLabel variant="on">
                                            <input pInputText formControlName="condition" />
                                            <label>Condition (e.g., BP, Diabetes)</label>
                                        </p-floatLabel>

                                    </div>
                                    <div class="field col-3">
                                        <p-floatLabel variant="on">
                                            <p-select
                                                [options]="[{label:'2 Months', value:'2M'},{label:'3 Months', value:'3M'},{label:'6 Months', value:'6M'}]"
                                                formControlName="checkupFrequency">
                                            </p-select>
                                            <label>Checkup Frequency</label>
                                        </p-floatLabel>
                                    </div>
                                    <div class="field col-3">
                                        <p-floatLabel variant="on">
                                            <p-datePicker formControlName="lastCheckupDate" showIcon iconDisplay="input"
                                                dateFormat="yy-mm-dd"></p-datePicker>
                                            <label>Last Checkup Date</label>
                                        </p-floatLabel>
                                    </div>
                                    <div class="field col-2 trash-btn">
                                        <button pButton type="button" icon="pi pi-trash"
                                            class="p-button-danger p-button-rounded p-button-text"
                                            (click)="removeHealthIssue(i)"></button>
                                    </div>
                                </div>
                            </div>

                            <!-- Vaccination History -->
                            <div class="heading mb-2 mt-4">Vaccination History</div>

                            <div formArrayName="vaccinations">
                                <div class="mb-3">
                                    <button pButton type="button" label="+ Add Vaccination" class="p-button-secondary"
                                        (click)="addVaccination()"></button>
                                </div>

                                <div *ngFor="let vac of vaccinations.controls; let i = index" [formGroupName]="i"
                                    class="p-fluid grid formgrid mb-3">
                                    <!-- Vaccine Name -->
                                    <div class="field col-4">
                                        <p-floatLabel variant="on">
                                            <p-select [options]="availableVaccines" formControlName="vaccineName"
                                                inputId="vaccineName{{i}}">
                                            </p-select>
                                            <label for="vaccineName{{i}}">Vaccine</label>
                                        </p-floatLabel>
                                    </div>

                                    <!-- Vaccinated (Yes/No) -->
                                    <div class="field col-4">
                                        <p-floatLabel variant="on">
                                            <p-select [options]="[{label:'Yes', value:true},{label:'No', value:false}]"
                                                formControlName="vaccinated" inputId="vaccinated{{i}}">
                                            </p-select>
                                            <label for="vaccinated{{i}}">Vaccinated?</label>
                                        </p-floatLabel>
                                    </div>
                                    <!-- Remove button -->
                                    <div class="field col-2 trash-btn">
                                        <button pButton type="button" icon="pi pi-trash"
                                            class="p-button-danger p-button-rounded p-button-text"
                                            (click)="removeVaccination(i)"></button>
                                    </div>

                                    <!-- Dose Dates (if vaccinated) -->
                                    <div *ngIf="vac.get('vaccinated')?.value" class="p-fluid grid formgrid mt-2">

                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-datePicker formControlName="firstDose" dateFormat="yy-mm-dd"
                                                    inputId="firstDose{{i}}"></p-datePicker>
                                                <label for="firstDose{{i}}">First Dose</label>
                                            </p-floatLabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-datePicker formControlName="secondDose" dateFormat="yy-mm-dd"
                                                    inputId="secondDose{{i}}"></p-datePicker>
                                                <label for="secondDose{{i}}">Second Dose</label>
                                            </p-floatLabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-datePicker formControlName="thirdDose" dateFormat="yy-mm-dd"
                                                    inputId="thirdDose{{i}}"></p-datePicker>
                                                <label for="thirdDose{{i}}">Third Dose</label>
                                            </p-floatLabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-datePicker formControlName="boosterDose" dateFormat="yy-mm-dd"
                                                    inputId="boosterDose{{i}}"></p-datePicker>
                                                <label for="boosterDose{{i}}">Booster Dose(s)</label>
                                            </p-floatLabel>
                                        </div>


                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <p-datePicker formControlName="testDate" dateFormat="yy-mm-dd"
                                                    inputId="testDate{{i}}"></p-datePicker>
                                                <label for="testDate{{i}}">Date of Test</label>
                                            </p-floatLabel>
                                        </div>
                                        <div class="field col-4">
                                            <p-floatLabel variant="on">
                                                <input pInputText formControlName="titerLevel" id="titerLevel{{i}}" />
                                                <label for="titerLevel{{i}}">Titer Level</label>
                                            </p-floatLabel>
                                        </div>
                                        <!-- Proof Upload -->
                                        <!-- <div class="field col-4 mt-2">
                                            <div class="file-upload-wrapper relative">
                                                <input type="file" class="custom-file-input"
                                                    (change)="onVaccineProofSelect($event, i)" />
                                                <small *ngIf="!vac.value.proofUrl && vac.value.proofFileName">{{ vac.value.proofFileName
                                                    }}</small>
                                                  <ng-container *ngIf="vac.value.proofUrl">
                                                    <a [href]="vac.value.proofUrl" target="_blank" rel="noopener noreferrer">
                                                      <i class="pi pi-file"></i> View Proof
                                                    </a>
                                                  </ng-container>
                                            </div>
                                        </div> -->
                                        <div class="field col-4 mt-2">
                                            <div class="file-upload-wrapper relative">
                                                <!-- File input (for uploading new proof) -->
                                                <input type="file" class="custom-file-input"
                                                    (change)="onVaccineProofSelect($event, i)" />

                                                <!-- Show local file name if user just selected -->
                                                <small *ngIf="vac.value.proofFileName">{{ vac.value.proofFileName
                                                    }}</small>

                                                <!-- OR show existing proofUrl as link -->
                                                <ng-container *ngIf="vac.value.proofUrl && vac.value.proofFileName">
                                                    <a [href]="vac.value.proofUrl" target="_blank"
                                                        rel="noopener noreferrer">
                                                        <i class="pi pi-file"></i> View Proof
                                                    </a>
                                                </ng-container>
                                            </div>
                                        </div>

                                    </div>



                                </div>
                            </div>


                            <!-- Emergency Info -->
                            <div class="heading mb-2 mt-3">Emergency Medical Info</div>
                            <div class="p-fluid grid formgrid">
                                <div class="field col-6">
                                    <p-floatlabel variant="on">
                                        <input pInputText formControlName="preferredHospital" />
                                        <label>
                                            Preferred Hospital
                                        </label>
                                    </p-floatlabel>
                                </div>
                                <div class="field col-6">
                                    <p-floatlabel variant="on">
                                        <input pInputText formControlName="primaryPhysician" />
                                        <label>
                                            Primary Physician Contact
                                        </label>
                                    </p-floatlabel>
                                </div>
                                <div class="field col-12">
                                    <p-floatlabel variant="on">
                                        <textarea pInputTextarea formControlName="emergencyNotes"></textarea>
                                        <label>Special Notes (e.g., pacemaker, allergy)</label>
                                    </p-floatlabel>
                                </div>
                            </div>

                            <!-- Buttons -->
                            <div class="flex py-6 gap-2 btn">
                                <p-button label="Previous" severity="secondary" (onClick)="activateCallback(4)" />
                                <p-button type="submit" label="Submit" [disabled]="employeeForm.invalid"></p-button>
                            </div>
                        </ng-template>
                    </p-step-panel>
                </p-step-item>

            </p-stepper>
        </form>
    </div>

</div>

<p-dialog header="Document Preview" [(visible)]="docDialogVisible" [modal]="true"
    [style]="{ width: '80vw', height: '90vh' }" [contentStyle]="{ overflow: 'auto' }" [dismissableMask]="true">
    <ng-container *ngIf="selectedDocUrl">
        <iframe *ngIf="
      safeDocUrl &&
      selectedDocUrl &&
      (selectedDocUrl.toLowerCase().includes('application/pdf') ||
       selectedDocUrl.toLowerCase().endsWith('.pdf'))
    " [src]="safeDocUrl" width="100%" height="600px" style="border:none"></iframe>


        <!-- If Image -->
        <img *ngIf="selectedDocUrl.toLowerCase().includes('image/')" [src]="selectedDocUrl" alt="Document"
            style="max-width:100%;max-height:600px;" />

        <!-- Other file types -->
        <div class="flex align-items-center justify-content-center" *ngIf="!selectedDocUrl.toLowerCase().includes('image/') &&
             !selectedDocUrl.toLowerCase().includes('application/pdf')">

                <!-- <a [href]="selectedDocUrl" target="_blank" rel="noopener noreferrer" style="color: black;">Open in new tab</a> -->
                 <img [src]="selectedDocUrl" alt="Document" style="max-width:100%;max-height:600px;" />
            
        </div>
    </ng-container>

</p-dialog>