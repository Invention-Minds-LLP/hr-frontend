<div class="leave-request">
    <div class="header">
        <div class="flex">
            <!-- Filter -->
            <div class="filter" id="filterButton" (click)="toggleFilterDropdown(); $event.stopPropagation()">
                <i class="pi pi-filter"></i>

                <ul class="menu-list" id="filterDropdown" *ngIf="showFilterDropdown">
                    <li class="list" *ngFor="let option of filterOptions"
                        (click)="selectFilter(option); $event.stopPropagation()"
                        [ngClass]="{ active: selectedFilter?.value === option.value }">
                        {{ option.label }}
                    </li>
                </ul>
            </div>

            <!-- Search -->
            <p-iconfield>
                <p-inputicon class="pi pi-search"></p-inputicon>
                <input id="searchBox" type="text" pInputText placeholder="Search" (input)="onSearch($event)" />
            </p-iconfield>

        </div>

    </div>

    <div class="table">
        <ng-container *ngIf="loading; else leaveTable">
            <p-table [value]="[1, 2, 3, 4, 5]" [scrollable]="true" scrollHeight="600px">
                <!-- Header -->
                <ng-template pTemplate="header">
                    <tr>
                        <th
                            *ngFor="let h of ['No','Name','Emp ID','Department','Title','Type','Dates','Reason','Status','Action']">
                            {{ h }}
                        </th>
                    </tr>
                </ng-template>

                <!-- Body -->
                <ng-template pTemplate="body">
                    <tr>
                        <td><p-skeleton width="2rem"></p-skeleton></td>

                        <td>
                            <div class="profile-skeleton">
                                <p-skeleton shape="circle" size="3rem" styleClass="profile-avatar"></p-skeleton>
                                <div class="profile-text">
                                    <p-skeleton width="90px" styleClass="mb-1"></p-skeleton>
                                    <p-skeleton width="60px"></p-skeleton>
                                </div>
                            </div>
                        </td>

                        <td><p-skeleton width="70px"></p-skeleton></td>
                        <td><p-skeleton width="90px"></p-skeleton></td>
                        <td><p-skeleton width="100px"></p-skeleton></td>
                        <td><p-skeleton width="60px"></p-skeleton></td>
                        <td><p-skeleton width="80px"></p-skeleton></td>
                        <td><p-skeleton width="100px"></p-skeleton></td>
                        <td><p-skeleton width="60px"></p-skeleton></td>
                        <td><p-skeleton width="80px"></p-skeleton></td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-container>



        <!-- ✅ Actual Leave Table once data loads -->
        <ng-template #leaveTable>
            <p-table [value]="filteredLeaveData" [paginator]="true" [rows]="10">
                <ng-template pTemplate="header">
                    <tr>
                        <th>No</th>
                        <th>Employee Name</th>
                        <th>Emp ID</th>
                        <th>Department</th>
                        <th>Job Title</th>
                        <th>Leave Type</th>
                        <th>Leave Dates</th>
                        <th>Reason</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-leaveData let-rowIndex="rowIndex">
                    <tr>
                        <td>{{ rowIndex + 1 }}</td>
                        <td class="empname">
                            <img class="image" src="/img.png" alt="" />
                            <div>
                                <div class="name">{{ leaveData.empName }}</div>
                                <span class="email">{{ leaveData.email }}</span>
                            </div>
                        </td>
                        <td>{{ leaveData.empId }}</td>
                        <td>
                            <span class="dept-badge" [ngStyle]="{
                  backgroundColor: getDepartmentColors(leaveData.department).badgeColor}">
                                <span class="dot" [ngStyle]="{
                    backgroundColor: getDepartmentColors(leaveData.department).dotColor}"></span>
                                {{ getDepartmentName(leaveData.department) }}
                            </span>
                        </td>
                        <td>{{ leaveData.jobTitle }}</td>
                        <td>{{ leaveData.leaveType }}</td>
                        <td>{{ leaveData.leaveDate }}</td>
                        <td>
                            <span [pTooltip]="leaveData.reson" tooltipPosition="top">
                                {{ leaveData.reson | slice: 0:20
                                }}<span *ngIf="leaveData.reson.length > 20">...</span>
                            </span>
                        </td>
                        <td>{{ getStatusLabel(leaveData) }}</td>
                        <!-- <td>
                            <div class="btns">

                                <ng-container *ngIf="role === 'Reporting Manager' || role === 'Manager'">
                                    <button *ngIf="leaveData.hodDecision === 'PENDING'" class="btn-1 btn"
                                        (click)="acceptLeave(leaveData.id, 'MANAGER')">
                                        Approve
                                    </button>
                                    <button *ngIf="leaveData.hodDecision === 'PENDING'" class="btn-2 btn"
                                        (click)="openDeclineDialog(leaveData.id, 'MANAGER')">
                                        Decline
                                    </button>
                                </ng-container>

                                <ng-container *ngIf="isHR">
                                    <button
                                        *ngIf="leaveData.hodDecision === 'APPROVED' && leaveData.hrDecision === 'PENDING'"
                                        class="btn-1 btn" (click)="acceptLeave(leaveData.id, 'HR')">
                                        Approve
                                    </button>
                                    <button
                                        *ngIf="leaveData.hodDecision === 'APPROVED' && leaveData.hrDecision === 'PENDING'"
                                        class="btn-2 btn" (click)="openDeclineDialog(leaveData.id, 'HR')">
                                        Decline
                                    </button>
                                </ng-container>
                                <button class="btn-3" (click)="openLeaveDetails(leaveData)">
                                    Leave Details
                                </button>
                            </div>
                        </td> -->
                        <td>
                            <div class="btns">

                                <!-- LEVEL 1 Approve -->
                                <button *ngIf="showLevel1Approve(leaveData)" class="btn-1 btn"
                                    (click)="acceptLeave(leaveData.id, 'LEVEL1')" disabled]="loadingRows[leaveData.id]">

                                    <span *ngIf="!loadingRows[leaveData.id]">Approve</span>

                                    <span *ngIf="loadingRows[leaveData.id]" class="spinner-wrapper">
                                        <i class="pi pi-spin pi-spinner"></i>

                                    </span>
                                </button>

                                <button *ngIf="showLevel1Approve(leaveData)" class="btn-2 btn"
                                    (click)="openDeclineDialog(leaveData.id, 'LEVEL1')">
                                    Decline
                                </button>

                                <!-- LEVEL 2 Approve (HR Manager only when required) -->
                                <button *ngIf="showLevel2Approve(leaveData)" class="btn-1 btn"
                                    (click)="acceptLeave(leaveData.id, 'LEVEL2')"
                                    [disabled]="loadingRows[leaveData.id]">

                                    <span *ngIf="!loadingRows[leaveData.id]">Approve</span>

                                    <span *ngIf="loadingRows[leaveData.id]" class="spinner-wrapper">
                                        <i class="pi pi-spin pi-spinner"></i>

                                    </span>
                                </button>

                                <button *ngIf="showLevel2Approve(leaveData)" class="btn-2 btn"
                                    (click)="openDeclineDialog(leaveData.id, 'LEVEL2')">
                                    Decline
                                </button>

                                <!-- Always available -->
                                <button class="btn-3" (click)="openLeaveDetails(leaveData)">
                                    Leave Details
                                </button>

                            </div>
                        </td>

                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="10" class="no-data-message">
                            <i class="pi pi-info-circle"></i> No Leave requests found.
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </ng-template>
    </div>
</div>

<!-- <app-leave-popup *ngIf="showLeaveDetailsPopup" [showPopup]="true" [leaveData]="selectedLeaveForView"
[isViewOnly]="true" (close)="showLeaveDetailsPopup = false">
</app-leave-popup> -->

<!-- Decline Reason Popup -->
<div class="custom-popup" *ngIf="declineDialogVisible">
    <div class="popup-content">
        <h3>Leave Request Decline Reason</h3>
        <hr>
        <textarea placeholder="Type your reason here..." [(ngModel)]="declineReason" rows="4"></textarea>

        <div class="popup-actions">
            <button class="btn btn-green" (click)="confirmDecline()" [disabled]="declineLoading">

                <ng-container *ngIf="!declineLoading; else leaveDeclining">
                    Decline
                </ng-container>

                <ng-template #leaveDeclining>
                    <i class="pi pi-spin pi-spinner"></i>
                </ng-template>

            </button>

            <button class="btn btn-red" (click)="closeDeclineDialog()">Cancel</button>
        </div>
    </div>
</div>

<!-- top badges -->
<div class="leave-dashboard-popup" *ngIf="showLeaveDetailsPopup">
    <div class="leave-dashboard-container">
        <div class="badges">
            <div class="badge">
                <div class="big green">{{ dashboard?.remaining ?? 0 | number:'2.0' }}</div>
                <div class="label">Leave Available</div>
            </div>
            <div class="badge">
                <div class="big red">{{ dashboard?.takenYtd ?? 0 | number:'2.0' }}</div>
                <div class="label">Leaves Taken</div>
            </div>
            <div class="badge">
                <div class="big amber">{{ dashboard?.takenThisMonth ?? 0 | number:'2.0' }}</div>
                <div class="label">This Month</div>
            </div>
        </div>

        <div class="layout">
            <div class="left-form">
                <app-leave-popup [showPopup]="true" [leaveData]="selectedLeaveForView" [isViewOnly]="true"
                    [hasBackdrop]="false" (close)="closePopup()">
                </app-leave-popup>
            </div>

            <!-- right side: who’s on leave today -->
            <aside class="who-panel">
                <div class="who-title"><i class="pi pi-users"></i> Who’s on Leave</div>

                <hr />

                <!-- Today -->
                <div class="who-section">
                    <div class="section-title">Today</div>
                    <ng-container *ngIf="buckets.today.length; else emptyToday">
                        <div class="who-item" *ngFor="let p of visible(buckets.today,'today')">
                            <img class="image" [src]="'/img.png'" alt="" />
                            <div>
                                <div class="name">{{ p.name }}</div>
                                <div class="role">{{ p.title || '—' }}</div>
                            </div>
                        </div>

                        <button *ngIf="moreCount(buckets.today) > 0" class="more-btn" (click)="toggle('today')">
                            <ng-container *ngIf="!expanded.today">+{{ moreCount(buckets.today) }}
                                more</ng-container>
                            <ng-container *ngIf="expanded.today">show less</ng-container>
                            <i class="pi" [ngClass]="expanded.today ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                        </button>
                    </ng-container>
                    <ng-template #emptyToday>
                        <div class="muted">—</div>
                    </ng-template>
                </div>

                <!-- This week -->
                <div class="who-section">
                    <div class="section-title">This week</div>
                    <ng-container *ngIf="buckets.thisWeek.length; else emptyWeek">
                        <div class="who-item" *ngFor="let p of visible(buckets.thisWeek,'thisWeek')">
                            <img class="image" [src]="'/img.png'" alt="" />
                            <div>
                                <div class="name">{{ p.name }}</div>
                                <div class="role">{{ p.title || '—' }}</div>
                            </div>
                        </div>

                        <button *ngIf="moreCount(buckets.thisWeek) > 0" class="more-btn" (click)="toggle('thisWeek')">
                            <ng-container *ngIf="!expanded.thisWeek">+{{ moreCount(buckets.thisWeek) }}
                                more</ng-container>
                            <ng-container *ngIf="expanded.thisWeek">show less</ng-container>
                            <i class="pi" [ngClass]="expanded.thisWeek ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                        </button>
                    </ng-container>
                    <ng-template #emptyWeek>
                        <div class="muted">—</div>
                    </ng-template>
                </div>

                <!-- Next month -->
                <div class="who-section">
                    <div class="section-title">Next Month</div>
                    <ng-container *ngIf="buckets.nextMonth.length; else emptyNext">
                        <div class="who-item" *ngFor="let p of visible(buckets.nextMonth,'nextMonth')">
                            <img class="image" [src]="'/img.png'" alt="" />
                            <div>
                                <div class="name">{{ p.name }}</div>
                                <div class="role">{{ p.title || '—' }}</div>
                            </div>
                        </div>

                        <button *ngIf="moreCount(buckets.nextMonth) > 0" class="more-btn" (click)="toggle('nextMonth')">
                            <ng-container *ngIf="!expanded.nextMonth">+{{ moreCount(buckets.nextMonth) }}
                                more</ng-container>
                            <ng-container *ngIf="expanded.nextMonth">show less</ng-container>
                            <i class="pi" [ngClass]="expanded.nextMonth ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                        </button>
                    </ng-container>
                    <ng-template #emptyNext>
                        <div class="muted">—</div>
                    </ng-template>
                </div>
            </aside>

        </div>
    </div>

</div>

<p-toast position="top-right"></p-toast>
