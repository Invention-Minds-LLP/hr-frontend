<p-card class="leave-request">
    <div class="table-header">
        <h3>My Team – Shift Assignment</h3>

        <div class="header-actions">
            <button class="assign-test" (click)="openPatternModal()">
                Create Rotation Pattern
                <i class="pi pi-plus"></i>
            </button>
            <!-- <button class="assign-test" [disabled]="!selectedEmployees.length" (click)="openBulkAssign()">

                Bulk Assign Rotation
            </button> -->
            <button  label="Bulk Request" class="assign-test" icon="pi pi-send" [disabled]="!selectedEmployees.length"
                (click)="openBulkRequest()">
                Bulk Request
            </button>
        </div>

    </div>


    <p-table [value]="employees" [(selection)]="selectedEmployees" [paginator]="true" [rows]="10"
        responsiveLayout="scroll">

        <!-- HEADER -->
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 40px">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th>No</th>
                <th>Employee</th>
                <th>Phone</th>
                <th>Department</th>
                <th>Designation</th>
                <th>Employment</th>
                <th>Shift Mode</th>
                <th>Current Shift</th>
                <th>Action</th>
            </tr>
        </ng-template>

        <!-- BODY -->
        <ng-template pTemplate="body" let-e let-i="rowIndex">
            <tr>
                <td>
                    <p-tableCheckbox [value]="e"></p-tableCheckbox>
                </td>
                <!-- No -->
                <td>{{ i + 1 }}</td>

                <!-- Employee -->
                <td>
                    <strong>{{ e.firstName }} {{ e.lastName }}</strong>
                    <div class="muted">{{ e.employeeCode }}</div>
                </td>

                <!-- Phone -->
                <td>{{ e.phone }}</td>

                <!-- Department -->
                <td>{{ e.Department?.name || '-' }}</td>

                <!-- Designation -->
                <td>{{ e.designation?.name || '-' }}</td>

                <!-- Employment -->
                <td>{{ e.employmentType }}</td>

                <!-- Mode -->
                <td>
                    <p-tag [value]="e.EmployeeShiftSetting?.mode || 'NONE'" severity="info">
                    </p-tag>
                </td>

                <!-- Current Shift -->
                <td>

                    <!-- FIXED -->
                    <ng-container *ngIf="e.EmployeeShiftSetting?.mode === 'FIXED'">
                        <ng-container *ngIf="getShiftById(e.EmployeeShiftSetting?.fixedShiftId) as shift">

                            <strong>{{ shift.name }}</strong>
                            <span class="shift-time">
                                ({{ formatTime(shift.startTime) }} – {{ formatTime(shift.endTime) }})
                            </span>

                        </ng-container>
                    </ng-container>

                    <!-- ROTATIONAL -->
                    <ng-container *ngIf="e.EmployeeShiftSetting?.mode === 'ROTATIONAL'">
                        <span class="muted">Rotational</span>
                    </ng-container>

                    <!-- NONE -->
                    <ng-container *ngIf="!e.EmployeeShiftSetting">
                        -
                    </ng-container>

                </td>


                <!-- Action -->
                <td class="action-buttons">
                    <!-- <button class="edit-button" title="Assign / Change Shift" (click)="openAssign(e)">
                        <i class="pi pi-pencil"></i>
                    </button> -->
                    <button icon="pi pi-send" class="assign-test" (click)="openSingleRequest(e)" pTooltip="Change Shift" tooltipPosition="top">
                        
                        <i class="pi pi-send"></i>
                    </button>
                </td>
            </tr>
        </ng-template>

    </p-table>
</p-card>


<p-dialog header="Assign Shift" [(visible)]="selectedEmployee" [modal]="true" [style]="{ width: '400px' }"
    [closable]="false">
    <ng-template pTemplate="header">
        <div class="dialog-header-custom">
            <span>
                Assign Shift
            </span>

            <button class="dialog-close-btn" (click)="selectedEmployee = null">
                ✕
            </button>
        </div>
    </ng-template>
    <label>Mode</label>
    <p-select [options]="[
      { label: 'Fixed', value: 'FIXED' },
      { label: 'Rotational', value: 'ROTATIONAL' }
    ]" [(ngModel)]="selectedMode">
    </p-select>

    <div class="mt-4 mb-5" *ngIf="selectedMode === 'FIXED'">
        <label> Shifts</label>
        <p-select [options]="executiveShifts" optionLabel="name" optionValue="id" [(ngModel)]="selectedShiftId"
            appendTo="body">
        </p-select>
    </div>

    <div class="mt-4 mb-5" *ngIf="selectedMode === 'ROTATIONAL'">
        <label>Rotation Pattern</label>
        <p-select [options]="patterns" optionLabel="name" optionValue="id" [(ngModel)]="selectedPatternId"
            appendTo="body">
        </p-select>
    </div>

    <div class="mt-4 mb-5" *ngIf="selectedMode === 'ROTATIONAL'">
        <label>Start Date</label>
        <p-datepicker [(ngModel)]="startDate" appendTo="body"></p-datepicker>
    </div>

    <!-- <button pButton label="Save" (click)="save()"></button> -->
    <button pButton [label]="assignLoading ? 'Saving...' : 'Save'" [loading]="assignLoading" [disabled]="assignLoading">
    </button>

</p-dialog>

<p-dialog header="Create Rotation Pattern" [(visible)]="patternVisible" [modal]="true" [style]="{ width: '500px' }"
    [closable]="false">

    <ng-template pTemplate="header">
        <div class="dialog-header-custom">
            <span>Create Rotation Pattern</span>
            <button class="dialog-close-btn" (click)="patternVisible = false">✕</button>
        </div>
    </ng-template>

    <div class="dialog-body">

        <!-- Pattern Name + Cycle -->
        <div class="pattern-grid">
            <div>
                <label>Pattern Name</label>
                <!-- <input pInputText [(ngModel)]="patternForm.name" placeholder="January - 2026" /> -->
                <p-select [options]="patternNameOptions" optionLabel="label" optionValue="value"
                    [(ngModel)]="patternForm.name" placeholder="Select Month & Year" appendTo="body">
                </p-select>
            </div>

            <div>
                <label>Weeks</label>
                <input pInputText type="number" [(ngModel)]="patternForm.cycleDays"
                    (ngModelChange)="onCycleDaysChange($event)" placeholder="Week" min="1" />
            </div>
        </div>

        <!-- Day wise shifts -->
        <label class="mt-3 block">Week-wise Shifts</label>

        <div class="rotation-row" *ngFor="let item of patternItems; let i = index">

            <span class="day-label">Week {{ item.dayIndex + 1 }}</span>

            <p-select [options]="getAvailableShifts(i)" optionLabel="label" optionValue="id" [(ngModel)]="item.shiftId"
                placeholder="Select shifts" appendTo="body">
            </p-select>

            <button class="remove-btn" (click)="removePatternItem(i)">✕</button>
        </div>

        <!-- <div class="add-day-wrapper">
      <button
        pButton
        label="Add Day"
        icon="pi pi-plus"
        class="p-button-text"
        (click)="addPatternItem()">
      </button>
    </div> -->

        <!-- Actions -->
        <div class="dialog-actions">
            <button pButton label="Cancel" class="p-button-text" (click)="patternVisible = false">
            </button>

            <!-- <button pButton label="Save" (click)="saveRotationPattern()" [loading]="patternSaving"> -->
            <button pButton [label]="patternSaving ? 'Saving...' : 'Save'" [loading]="patternSaving"
                [disabled]="patternSaving" (click)="saveRotationPattern()">
            </button>

        </div>

    </div>
</p-dialog>

<p-dialog header="Bulk Assign Rotation" [(visible)]="bulkVisible" [modal]="true" [style]="{ width: '420px' }"
    [closable]="false">

    <ng-template pTemplate="header">
        <div class="dialog-header-custom">
            <span>Bulk Assign Rotation</span>
            <button class="dialog-close-btn" (click)="bulkVisible = false">✕</button>
        </div>
    </ng-template>

    <div class="dialog-body">

        <p class="muted">
            Assigning to {{ selectedEmployees.length }} employees
        </p>

        <div class="mb-4">
            <label>Rotation Pattern</label>
            <p-select [options]="patterns" optionLabel="name" optionValue="id" [(ngModel)]="bulkPatternId"
                appendTo="body" placeholder="Select rotation pattern">
            </p-select>
        </div>


        <div class="mt-4 mb-5">
            <label>Start Date</label>
            <p-datepicker [(ngModel)]="bulkStartDate" appendTo="body"></p-datepicker>
        </div>

        <div class="dialog-actions">
            <button pButton label="Cancel" class="p-button-text" (click)="bulkVisible = false"></button>

            <!-- <button pButton label="Assign" (click)="bulkAssign()"></button> -->
            <button class="dialog-close-btn" [disabled]="bulkAssigning" (click)="bulkVisible = false">
                ✕
            </button>

        </div>

    </div>
</p-dialog>

<p-dialog
  [(visible)]="requestVisible"
  header="Request Shift Change"
  [modal]="true"
  [style]="{ width: '420px' }"
  [closable]="false">

  <ng-template pTemplate="header">
    <div class="dialog-header-custom">
      <span>Request Shift Change</span>
      <button class="dialog-close-btn" (click)="closeRequestDialog()">✕</button>
    </div>
  </ng-template>

  <div class="dialog-body">

    <!-- EMPLOYEE INFO -->
    <p *ngIf="requestEmployees.length === 1">
      Employee:
      <strong>
        {{ requestEmployees[0].firstName }}
        {{ requestEmployees[0].lastName }}
      </strong>
    </p>

    <p *ngIf="requestEmployees.length > 1">
      Assigning to
      <strong>{{ requestEmployees.length }}</strong>
      employees
    </p>

    <!-- MODE -->
    <div class="mb-3">
      <label>Mode</label>
      <p-select
        [options]="modes"
        optionLabel="label"
        optionValue="value"
        appendTo="body"
        [(ngModel)]="requestForm.mode">
      </p-select>
    </div>

    <!-- FIXED -->
    <div *ngIf="requestForm.mode === 'FIXED'" class="mb-3">
      <label>Shift</label>
      <p-select
        [options]="executiveShifts"
        optionLabel="label"
        optionValue="id"
        appendTo="body"
        [(ngModel)]="requestForm.shiftId">
      </p-select>
    </div>

    <!-- ROTATIONAL -->
    <div *ngIf="requestForm.mode === 'ROTATIONAL'" class="mb-3">
      <label>Rotation Pattern</label>
      <p-select
        [options]="patterns"
        optionLabel="name"
        optionValue="id"
        appendTo="body"
        [(ngModel)]="requestForm.patternId">
      </p-select>
    </div>

    <!-- START DATE -->
    <div class="mb-3">
      <label>Start Date</label>
      <p-datepicker [(ngModel)]="requestForm.startDate" appendTo="body"></p-datepicker>
    </div>

    <!-- ACTIONS -->
    <div class="dialog-actions">
      <button
        pButton
        label="Cancel"
        class="p-button-text"
        (click)="closeRequestDialog()">
      </button>

      <button
        pButton
        [label]="requestLoading ? 'Submitting...' : 'Submit'"
        [loading]="requestLoading"
        (click)="submitRequest()">
      </button>
    </div>

  </div>
</p-dialog>